# CausalEngine v2.0.3 发布说明

**发布日期**: 2025年6月20日

## 🎯 核心改进：独立网络架构

### 主要变更

本版本对 `AbductionNetwork` 进行了重大架构优化，实现了真正的**独立网络设计**：

#### 1. 网络独立性 🔄
- **之前**: `loc_net` 和 `scale_net` 共享前置 MLP
- **现在**: 完全独立的网络路径
  - `loc_net`: `H → C` (独立路径)
  - `scale_net`: `H → C` (独立路径)

#### 2. 优雅的初始化策略 ✨
- **loc_net 恒等初始化**: 当 `H = C` 且 `mlp_layers = 1` 时
- **scale_net 常数初始化**: 最后一层初始化为 `gamma_init`
- **一般情况**: Xavier 初始化

#### 3. 数学优势 📊
- **完全解耦**: 两个网络可以独立优化
- **梯度独立**: 位置和尺度参数的学习完全分离
- **灵活性**: 可以为不同任务设计不同的网络结构

### 技术细节

#### 网络构建逻辑
```python
# loc_net 构建
if input_size == causal_size and mlp_layers == 1:
    # 特殊情况：直接线性层，恒等初始化
    self.loc_net = nn.Linear(input_size, causal_size, bias=True)
    self._loc_is_identity_candidate = True
else:
    # 一般情况：线性层或 MLP
    if mlp_layers == 1:
        self.loc_net = nn.Linear(input_size, causal_size, bias=True)
    else:
        self.loc_net = self._build_mlp(...)
    self._loc_is_identity_candidate = False

# scale_net 总是使用 MLP
self.scale_net = self._build_mlp(...)
```

#### 前向传播简化
```python
def forward(self, hidden_states):
    # 独立的网络路径
    loc_U = self.loc_net(hidden_states)
    scale_U = F.softplus(self.scale_net(hidden_states))
    return loc_U, scale_U
```

### 完整构建规则表

| 输入参数组合 | loc_net 构建 | scale_net 构建 | 初始化策略 |
|-------------|-------------|---------------|------------|
| **H=C, layers=1** | `nn.Linear(H,C)` | `nn.Linear(H,C)` | **loc:恒等**, scale:常数 |
| **H≠C, layers=1** | `nn.Linear(H,C)` | `nn.Linear(H,C)` | loc:Xavier, scale:常数 |
| **H=C, layers>1** | `MLP(H→C*2→C)` | `MLP(H→C*2→C)` | loc:Xavier, scale:常数 |
| **H≠C, layers>1** | `MLP(H→C*2→C)` | `MLP(H→C*2→C)` | loc:Xavier, scale:常数 |

### 架构描述示例

| 配置 | loc_net | scale_net |
|------|---------|-----------|
| H=C, layers=1 | Identity: 512 → 512 | Linear: 512 → 512 |
| H≠C, layers=1 | Linear: 768 → 256 | Linear: 768 → 256 |
| layers>1 | MLP(2): 512 → 1024 → 512 | MLP(2): 512 → 1024 → 512 |

### 验证结果

#### 1. 恒等映射测试
- 当 `H=C, layers=1` 时，`loc_net` 完美保持输入
- 误差: `< 1e-10`

#### 2. 梯度独立性测试
- `loc_loss` 反向传播只影响 `loc_net`
- `scale_loss` 反向传播只影响 `scale_net`
- 完全独立的参数更新

#### 3. 兼容性测试
- 所有现有测试通过
- API 完全向后兼容

### 设计优势

1. **数学清晰**: 位置和尺度推断完全分离
2. **优化灵活**: 可以针对不同目标独立调整网络
3. **初始化稳定**: 恒等初始化保证稳定的起点
4. **计算效率**: 避免不必要的共享计算

### 破坏性变更

**无破坏性变更** - 所有 API 保持兼容。

### 迁移指南

无需任何代码修改，现有代码将自动使用新的独立网络架构。

### 性能影响

- **内存**: 轻微增加（独立网络参数）
- **计算**: 可能略有增加，但提供更好的灵活性
- **训练**: 梯度独立性可能提供更好的收敛性

---

**完整变更**: [查看提交历史](../../)
**上一版本**: [v2.0.2](v2.0.2.md)
**下一版本**: TBD 