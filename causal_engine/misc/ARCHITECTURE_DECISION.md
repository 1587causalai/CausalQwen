# CausalEngine æ¶æ„å†³ç­–è®°å½•

## å†³ç­–æ ¸å¿ƒï¼šActivationHead ä½œä¸ºç‹¬ç«‹æ¨¡å—

### èƒŒæ™¯ä¸é—®é¢˜

åœ¨ CausalEngine v2.0 çš„æ¨¡å—åŒ–æ¶æ„è®¾è®¡ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªå…³é”®çš„æ¶æ„å†³ç­–é—®é¢˜ï¼š

**ä»»åŠ¡æ¿€æ´»ï¼ˆActivationHeadï¼‰åº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Ÿ**
- æ–¹æ¡ˆAï¼šä½œä¸º ActionNetwork çš„ä¸€éƒ¨åˆ†
- æ–¹æ¡ˆBï¼šä½œä¸ºç‹¬ç«‹æ¨¡å—ï¼ˆå½“å‰è®¾è®¡ï¼‰

è¿™ä¸ªå†³ç­–æ¶‰åŠåˆ°æ•°å­¦ç†è®ºçš„æ¸…æ™°æ€§ã€å·¥ç¨‹å®è·µçš„çµæ´»æ€§ï¼Œä»¥åŠæœªæ¥æ‰©å±•çš„å¯èƒ½æ€§ã€‚

### å†³ç­–ï¼šé€‰æ‹©æ–¹æ¡ˆ B - ç‹¬ç«‹æ¨¡å—

ç»è¿‡æ·±å…¥çš„æ•°å­¦åˆ†æå’Œå·¥ç¨‹å®è·µè€ƒé‡ï¼Œæˆ‘ä»¬é€‰æ‹©äº†**æ–¹æ¡ˆ B**ã€‚

---

## è¯¦ç»†åˆ†æ

### 1. æ•°å­¦åº•å±‚é€»è¾‘åˆ†æ

#### 1.1 å› æœæ¨ç†çš„æ•°å­¦æµç¨‹

æ•´ä¸ª CausalEngine çš„æ•°å­¦æ¡†æ¶åŸºäº **Y = f(U, Îµ)** å…¬å¼ï¼Œä½“ç°äº†ä¸‰ä¸ªæ¸…æ™°çš„æ•°å­¦é˜¶æ®µï¼š

```mermaid
graph TB
    subgraph "Mathematical Flow"
        Evidence["Evidence/Context X"] --> Individual["Individual U<br/>(Who am I?)"]
        Individual --> Decision["Decision S<br/>(What should I do?)"]
        Decision --> Output["Output Y<br/>(How to act?)"]
    end
    
    subgraph "Mathematical Definitions"
        M1["Stage 1: X â†’ U ~ Cauchy(Î¼_U, Î³_U)<br/>å½’å› æ¨æ–­ï¼šä»è¯æ®æ¨æ–­ä¸ªä½“"]
        M2["Stage 2: U â†’ S ~ Cauchy(loc_S, scale_S)<br/>è¡ŒåŠ¨å†³ç­–ï¼šåŸºäºä¸ªä½“è¿›è¡Œå†³ç­–"]
        M3["Stage 3: S â†’ Y (via CDF/Linear)<br/>ä»»åŠ¡æ¿€æ´»ï¼šå°†å†³ç­–è½¬æ¢ä¸ºè¾“å‡º"]
    end
    
    style Decision fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
```

#### 1.2 S å’Œ Y çš„æœ¬è´¨åŒºåˆ«

**Sï¼ˆå†³ç­–åˆ†å¸ƒï¼‰çš„æ•°å­¦ç‰¹æ€§**ï¼š
- **æŠ½è±¡æ€§**ï¼šS æ˜¯æŠ½è±¡çš„"å› æœå†³ç­–æ½œåŠ›"ï¼Œè¡¨ç¤ºä¸ªä½“åœ¨ç‰¹å®šæƒ…å†µä¸‹çš„å†³ç­–å€¾å‘
- **ä»»åŠ¡æ— å…³æ€§**ï¼šS åªä¾èµ–äºå› æœæœºåˆ¶ f(U, Îµ)ï¼Œä¸ä¾èµ–äºå…·ä½“ä»»åŠ¡
- **æ•°å­¦å®Œæ•´æ€§**ï¼šS ~ Cauchy(loc_S, scale_S) æ˜¯å®Œæ•´çš„æ¦‚ç‡åˆ†å¸ƒ
- **æŸ¯è¥¿ç¨³å®šæ€§**ï¼šS ä¿æŒæŸ¯è¥¿åˆ†å¸ƒçš„çº¿æ€§ç¨³å®šæ€§ç‰¹å¾

**Yï¼ˆä»»åŠ¡è¾“å‡ºï¼‰çš„æ•°å­¦ç‰¹æ€§**ï¼š
- **å…·ä½“æ€§**ï¼šY æ˜¯å…·ä½“çš„ã€ä»»åŠ¡ç›¸å…³çš„æœ€ç»ˆé¢„æµ‹ç»“æœ
- **ä»»åŠ¡ä¾èµ–æ€§**ï¼šY çš„å½¢å¼å®Œå…¨å–å†³äºæ¿€æ´»å‡½æ•°çš„é€‰æ‹©
- **å¤šæ ·æ€§**ï¼šY å¯ä»¥æ˜¯æ¦‚ç‡ã€æ•°å€¼ã€ç±»åˆ«ç´¢å¼•ç­‰ä¸åŒå½¢å¼
- **ç¡®å®šæ€§**ï¼šY é€šè¿‡æ¿€æ´»å‡½æ•°ä» S ç¡®å®šæ€§åœ°è®¡ç®—å¾—å‡º

#### 1.3 ä¸‰ç§æ¿€æ´»å‡½æ•°çš„æ•°å­¦å®ç°

**1. åˆ†ç±»æ¿€æ´»ï¼ˆBinary Classificationï¼‰**
```
P(S_k > C_k) = 1/2 + (1/Ï€) Ã— arctan((loc_S_k - C_k)/scale_S_k)
```

**2. å›å½’æ¿€æ´»ï¼ˆRegressionï¼‰**
```
Y_k = a_k Ã— loc_S_k + b_k
```

**3. ç¦»æ•£æœ‰åºæ¿€æ´»ï¼ˆOrdinal Classificationï¼‰** â­ **æ–°åŠŸèƒ½**
```
P(Y = k) = P(C_k < S â‰¤ C_{k+1})
å…¶ä¸­ C_0 = -âˆ, C_K = +âˆ

å…·ä½“è®¡ç®—ï¼š
P(Y = k) = CDF_Cauchy(C_{k+1}) - CDF_Cauchy(C_k)
         = [1/2 + (1/Ï€)arctan((C_{k+1} - loc_S)/scale_S)]
         - [1/2 + (1/Ï€)arctan((C_k - loc_S)/scale_S)]
```

---

### 2. æ¶æ„è®¾è®¡å¯¹æ¯”åˆ†æ

#### 2.1 å½“å‰æ¶æ„ï¼ˆæ–¹æ¡ˆ Bï¼‰ï¼šç‹¬ç«‹æ¨¡å—

```mermaid
graph LR
    subgraph "Current Architecture"
        X["Input Features X"] --> Abduction["AbductionNetwork<br/>X â†’ U ~ Cauchy(Î¼_U, Î³_U)"]
        Abduction --> Action["ActionNetwork<br/>U â†’ S ~ Cauchy(loc_S, scale_S)"]
        Action --> Activation["ActivationHead<br/>S â†’ Y (task-specific)"]
        
        Activation --> Y1["Classification<br/>P(S > C)"]
        Activation --> Y2["Regression<br/>aÂ·S + b"]
        Activation --> Y3["Ordinal â­<br/>P(C_k < S â‰¤ C_{k+1})"]
    end
    
    subgraph "Mathematical Flow"
        Evidence["Evidence/Context"] --> Individual["Individual U<br/>(Who am I?)"]
        Individual --> Decision["Decision S<br/>(What should I do?)"]
        Decision --> Output["Output Y<br/>(How to act?)"]
    end
    
    style Abduction fill:#e8f5e9
    style Action fill:#e3f2fd
    style Activation fill:#fff3e0
    style Y3 fill:#ffebee,stroke:#c62828,stroke-width:2px
```

#### 2.2 æ›¿ä»£æ¶æ„ï¼ˆæ–¹æ¡ˆ Aï¼‰ï¼šé›†æˆåˆ° ActionNetwork

```mermaid
graph LR
    subgraph "Alternative Architecture"
        X2["Input Features X"] --> Abduction2["AbductionNetwork<br/>X â†’ U ~ Cauchy(Î¼_U, Î³_U)"]
        Abduction2 --> ActionIntegrated["ActionNetwork + Activation<br/>U â†’ S â†’ Y (coupled)"]
        
        ActionIntegrated --> Y1_Alt["Mixed Output Y"]
    end
    
    subgraph "Issues with Alternative"
        Issue1["âŒ S is hidden<br/>(not accessible)"]
        Issue2["âŒ Tight coupling<br/>(hard to extend)"]
        Issue3["âŒ Single task only<br/>(no multi-task)"]
    end
    
    style ActionIntegrated fill:#ffebee,stroke:#c62828
    style Issue1 fill:#fff
    style Issue2 fill:#fff
    style Issue3 fill:#fff
```

---

### 3. å·¥ç¨‹å®è·µä¼˜åŠ¿

#### 3.1 æ¨¡å—åŒ–ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | ç‹¬ç«‹æ¨¡å—ï¼ˆå½“å‰ï¼‰ | é›†æˆæ¨¡å—ï¼ˆæ›¿ä»£ï¼‰ |
|------|------------------|------------------|
| **æ•°å­¦æ¸…æ™°æ€§** | âœ… S å’Œ Y æ¦‚å¿µæ¸…æ™°åˆ†ç¦» | âŒ S è¢«éšè—ï¼Œæ¦‚å¿µæ¨¡ç³Š |
| **å…³æ³¨ç‚¹åˆ†ç¦»** | âœ… å› æœæ ¸å¿ƒä¸ä»»åŠ¡é€»è¾‘è§£è€¦ | âŒ è´£ä»»æ··åˆï¼Œéš¾ä»¥ç»´æŠ¤ |
| **å¤šä»»åŠ¡æ”¯æŒ** | âœ… åŒä¸€ S é…ç½®å¤šä¸ªæ¿€æ´»å¤´ | âŒ éœ€è¦ä¿®æ”¹æ ¸å¿ƒç½‘ç»œ |
| **è¿ç§»å­¦ä¹ ** | âœ… é¢„è®­ç»ƒå› æœæ ¸å¿ƒï¼Œæ¢æ¿€æ´»å¤´ | âŒ æ•´ä¸ªç½‘ç»œéœ€è¦é‡æ–°è®­ç»ƒ |
| **ç‹¬ç«‹æµ‹è¯•** | âœ… å„æ¨¡å—å¯ç‹¬ç«‹éªŒè¯ | âŒ è€¦åˆæµ‹è¯•ï¼Œéš¾ä»¥å®šä½é—®é¢˜ |
| **æ‰©å±•æ€§** | âœ… æ–°æ¿€æ´»æ¨¡å¼æ— éœ€æ”¹æ ¸å¿ƒ | âŒ æ¯æ¬¡æ‰©å±•éƒ½å½±å“æ ¸å¿ƒç½‘ç»œ |

#### 3.2 å®é™…ä½¿ç”¨åœºæ™¯

**åœºæ™¯ 1ï¼šå¤šä»»åŠ¡å­¦ä¹ **
```python
# å…±äº«å› æœæ ¸å¿ƒï¼Œä¸åŒä»»åŠ¡ä½¿ç”¨ä¸åŒæ¿€æ´»å¤´
engine = CausalEngine(hidden_size=64, vocab_size=100, apply_activation=False)
loc_S, scale_S = engine(hidden_states)['loc_S'], engine(hidden_states)['scale_S']

# ä»»åŠ¡1ï¼šæ–‡æœ¬ç”Ÿæˆï¼ˆåˆ†ç±»ï¼‰
text_head = ActivationHead(100, "classification")
text_probs = text_head(loc_S, scale_S)

# ä»»åŠ¡2ï¼šæƒ…æ„Ÿè¯„åˆ†ï¼ˆç¦»æ•£æœ‰åºï¼‰
sentiment_head = ActivationHead(1, "ordinal", ordinal_num_classes=5)
sentiment_score = sentiment_head(loc_S[:, :, :1], scale_S[:, :, :1])

# ä»»åŠ¡3ï¼šæ•°å€¼é¢„æµ‹ï¼ˆå›å½’ï¼‰
value_head = ActivationHead(1, "regression")
predicted_value = value_head(loc_S[:, :, :1], scale_S[:, :, :1])
```

**åœºæ™¯ 2ï¼šæ¸è¿›å¼è®­ç»ƒ**
```python
# æ­¥éª¤1ï¼šé¢„è®­ç»ƒå› æœæ ¸å¿ƒ
causal_core = CausalEngine(hidden_size, vocab_size, apply_activation=False)
# ... è®­ç»ƒè¿‡ç¨‹ ...

# æ­¥éª¤2ï¼šä¸ºæ–°ä»»åŠ¡æ·»åŠ æ¿€æ´»å¤´ï¼ˆæ ¸å¿ƒæƒé‡å†»ç»“ï¼‰
new_task_head = ActivationHead(output_size, "ordinal", ordinal_num_classes=3)
# åªè®­ç»ƒæ–°æ¿€æ´»å¤´çš„å‚æ•°
```

---

### 4. ç¦»æ•£æœ‰åºæ¿€æ´»è¯¦ç»†å®ç°

#### 4.1 æ•°å­¦åŸç†

ç¦»æ•£æœ‰åºæ¿€æ´»å¤„ç†çš„æ˜¯**æœ‰åºåˆ†ç±»é—®é¢˜**ï¼Œå¦‚ï¼š
- 1-5æ˜Ÿè¯„åˆ†
- æƒ…æ„Ÿå¼ºåº¦ï¼ˆå¼ºçƒˆè´Ÿé¢ â†’ ä¸­æ€§ â†’ å¼ºçƒˆæ­£é¢ï¼‰
- ç½®ä¿¡åº¦ç­‰çº§ï¼ˆä½ â†’ ä¸­ â†’ é«˜ï¼‰

ä¸ä¼ ç»Ÿåˆ†ç±»ä¸åŒï¼Œç¦»æ•£æœ‰åºæ¿€æ´»è€ƒè™‘ç±»åˆ«é—´çš„**é¡ºåºå…³ç³»**ã€‚

**æ•°å­¦å…¬å¼**ï¼š
```
å¯¹äº K ä¸ªæœ‰åºç±»åˆ« {0, 1, ..., K-1}
è®¾é˜ˆå€¼åºåˆ—ï¼š-âˆ = C_0 < C_1 < C_2 < ... < C_{K-1} < C_K = +âˆ

P(Y = k) = P(C_k < S â‰¤ C_{k+1})
         = Î¦_Cauchy(C_{k+1}) - Î¦_Cauchy(C_k)

å…¶ä¸­ Î¦_Cauchy(c) = 1/2 + (1/Ï€)arctan((c - loc_S)/scale_S)
```

#### 4.2 å®ç°ç»†èŠ‚

```python
class ActivationMode(Enum):
    CLASSIFICATION = "classification"
    REGRESSION = "regression"
    ORDINAL = "ordinal"  # â­ æ–°å¢

# åœ¨ ActivationHead ä¸­çš„å®ç°
def forward(self, loc_S, scale_S):
    # ... å…¶ä»–æ¿€æ´»æ¨¡å¼ ...
    
    # ç¦»æ•£æœ‰åºæ¿€æ´»
    if self.ordinal_dims:
        for dim_idx in self.ordinal_dims:
            loc_S_ord = loc_S[:, :, dim_idx:dim_idx+1]
            scale_S_ord = scale_S[:, :, dim_idx:dim_idx+1]
            
            num_classes = self.ordinal_num_classes[dim_idx]
            thresholds = self.ordinal_thresholds[f'ordinal_{dim_idx}']
            
            # æ„å»ºå®Œæ•´é˜ˆå€¼åºåˆ—
            full_thresholds = torch.cat([
                torch.tensor(float('-inf')).unsqueeze(0),
                thresholds,
                torch.tensor(float('+inf')).unsqueeze(0)
            ])
            
            # è®¡ç®—æ¯ä¸ªåŒºé—´æ¦‚ç‡
            probs = []
            for k in range(num_classes):
                # P(Y=k) = P(S <= C_{k+1}) - P(S <= C_k)
                upper_cdf = 0.5 + (1/Ï€) * atan((C_{k+1} - loc_S) / scale_S)
                lower_cdf = 0.5 + (1/Ï€) * atan((C_k - loc_S) / scale_S)
                prob_k = upper_cdf - lower_cdf
                probs.append(prob_k)
            
            # è¿”å›æœ€å¤§æ¦‚ç‡ç±»åˆ«
            ordinal_probs = torch.cat(probs, dim=-1)
            output[:, :, dim_idx] = torch.argmax(ordinal_probs, dim=-1).float()
```

---

### 5. åŠŸèƒ½éªŒè¯ä¸æµ‹è¯•ç»“æœ

#### 5.1 æµ‹è¯•è„šæœ¬è®¾è®¡

æˆ‘ä»¬åˆ›å»ºäº† `scripts/test_ordinal_activation.py` æ¥éªŒè¯æ–°åŠŸèƒ½ï¼š

```python
# æµ‹è¯•1ï¼šæ··åˆæ¿€æ´»æ¨¡å¼
activation_modes = [
    "classification",  # 0,1,6,9: äºŒåˆ†ç±»
    "regression",      # 2,3,8: æ•°å€¼å›å½’  
    "ordinal",         # 4,5,7: ç¦»æ•£æœ‰åº
]
ordinal_num_classes = [5, 3, 10]  # 5çº§è¯„åˆ†ï¼Œ3çº§æƒ…æ„Ÿï¼Œ10çº§ç½®ä¿¡åº¦

# æµ‹è¯•2ï¼šçº¯ç¦»æ•£æœ‰åºæ¿€æ´»
engine = CausalEngine(
    hidden_size=32,
    vocab_size=3,
    activation_modes="ordinal",
    ordinal_num_classes=4
)
```

#### 5.2 å®é™…æµ‹è¯•ç»“æœ

**æ··åˆæ¿€æ´»æ¨¡å¼æµ‹è¯•è¾“å‡º**ï¼š
```
=== CausalEngine æ··åˆæ¿€æ´»æ¨¡å¼æµ‹è¯• ===

è¾“å…¥å½¢çŠ¶: torch.Size([2, 3, 64])
è¾“å‡ºå½¢çŠ¶: torch.Size([2, 3, 10])

1. åˆ†ç±»ç»´åº¦ (0, 1, 6, 9):
   æ¦‚ç‡å€¼: [0.5179, 0.5301, 0.4888, 0.5105]
   (æ¯ä¸ªå€¼è¡¨ç¤º P(S > C) çš„æ¦‚ç‡)

2. å›å½’ç»´åº¦ (2, 3, 8):
   æ•°å€¼è¾“å‡º: [-0.5787, 0.0814, -1.5689]
   (çº¿æ€§å˜æ¢åçš„å€¼: a*S + b)

3. ç¦»æ•£æœ‰åºç»´åº¦:
   - ç»´åº¦4 (5çº§è¯„åˆ†): é¢„æµ‹çº§åˆ« = 5/5    â­
   - ç»´åº¦5 (3çº§æƒ…æ„Ÿ): é¢„æµ‹çº§åˆ« = æ­£é¢   â­
   - ç»´åº¦7 (10çº§ç½®ä¿¡): é¢„æµ‹çº§åˆ« = 10/10 â­

4. åº•å±‚å†³ç­–åˆ†å¸ƒå‚æ•° S ~ Cauchy(loc_S, scale_S):
   loc_S[0, 0, :5]: [0.6827, 1.2039, -0.5787, 0.0814, 1.4750]
   scale_S[0, 0, :5]: [12.109, 12.712, 11.991, 10.393, 12.031]

5. ä¸ªä½“è¡¨å¾åˆ†å¸ƒ U ~ Cauchy(loc_U, scale_U):
   loc_U[0, 0, :5]: [0.3770, 0.2273, 0.5930, 2.4014, 0.6012]
   scale_U[0, 0, :5]: [1.3133, 1.3133, 1.3133, 1.3133, 1.3133]
```

**çº¯ç¦»æ•£æœ‰åºæ¿€æ´»æµ‹è¯•è¾“å‡º**ï¼š
```
=== çº¯ç¦»æ•£æœ‰åºæ¿€æ´»æµ‹è¯• ===

æ‰€æœ‰3ä¸ªç»´åº¦éƒ½æ˜¯4çº§ç¦»æ•£æœ‰åºè¾“å‡º
é¢„æµ‹ç»“æœ: [3.0, 3.0, 3.0]
(0=ç¬¬1çº§, 1=ç¬¬2çº§, 2=ç¬¬3çº§, 3=ç¬¬4çº§)
```

#### 5.3 è¯¦ç»†æ•°å­¦éªŒè¯ç»“æœ

ä¸ºäº†ç¡®ä¿ç¦»æ•£æœ‰åºæ¿€æ´»çš„æ•°å­¦å®ç°æ­£ç¡®ï¼Œæˆ‘ä»¬è¿›è¡Œäº†è¯¦ç»†çš„æ‰‹å·¥è®¡ç®—éªŒè¯ï¼š

**æµ‹è¯•æ¡ˆä¾‹ï¼š4çº§ç¦»æ•£æœ‰åºåˆ†ç±»ï¼Œé˜ˆå€¼ä¸º [-1.0, 0.0, 1.0]**

```
æµ‹è¯•æ¡ˆä¾‹ 1: å¼ºçƒˆåå‘ç¬¬1ç±» (loc_S=-2.0, scale_S=1.0)
----------------------------------------
é˜ˆå€¼åºåˆ—: [-âˆ, -1.00, 0.00, 1.00, +âˆ]

ç±»åˆ« 0: P(-âˆ < S â‰¤ -1.00) = 0.7500
ç±»åˆ« 1: P(-1.00 < S â‰¤ 0.00) = 0.1024  
ç±»åˆ« 2: P(0.00 < S â‰¤ 1.00) = 0.0452
ç±»åˆ« 3: P(1.00 < S â‰¤ +âˆ) = 0.1024

æ¦‚ç‡åˆ†å¸ƒ: [0.7500, 0.1024, 0.0452, 0.1024]
æ¦‚ç‡å’Œ: 1.0000 âœ…
é¢„æµ‹ç±»åˆ«: 0 âœ…
```

```
æµ‹è¯•æ¡ˆä¾‹ 2: å¼ºçƒˆåå‘ç¬¬4ç±» (loc_S=2.0, scale_S=1.0)
----------------------------------------
ç±»åˆ« 0: P(-âˆ < S â‰¤ -1.00) = 0.1024
ç±»åˆ« 1: P(-1.00 < S â‰¤ 0.00) = 0.0452
ç±»åˆ« 2: P(0.00 < S â‰¤ 1.00) = 0.1024
ç±»åˆ« 3: P(1.00 < S â‰¤ +âˆ) = 0.7500

æ¦‚ç‡åˆ†å¸ƒ: [0.1024, 0.0452, 0.1024, 0.7500]
æ¦‚ç‡å’Œ: 1.0000 âœ…
é¢„æµ‹ç±»åˆ«: 3 âœ…
```

```
æµ‹è¯•æ¡ˆä¾‹ 3: é«˜ä¸ç¡®å®šæ€§ (loc_S=0.0, scale_S=5.0)
----------------------------------------
ç±»åˆ« 0: P(-âˆ < S â‰¤ -1.00) = 0.4372
ç±»åˆ« 1: P(-1.00 < S â‰¤ 0.00) = 0.0628
ç±»åˆ« 2: P(0.00 < S â‰¤ 1.00) = 0.0628
ç±»åˆ« 3: P(1.00 < S â‰¤ +âˆ) = 0.4372

æ¦‚ç‡åˆ†å¸ƒ: [0.4372, 0.0628, 0.0628, 0.4372]
æ¦‚ç‡å’Œ: 1.0000 âœ…
é¢„æµ‹ç±»åˆ«: 0 (åœ¨ä¸ç¡®å®šæ€§é«˜æ—¶ï¼Œå€¾å‘äºæç«¯ç±»åˆ«)
```

**å…³é”®éªŒè¯æŒ‡æ ‡**ï¼š
- âœ… **ä¸€è‡´æ€§éªŒè¯**: æ‰‹åŠ¨è®¡ç®—ä¸ ActivationHead è‡ªåŠ¨è®¡ç®—ç»“æœå®Œå…¨ä¸€è‡´
- âœ… **æ¦‚ç‡å®Œæ•´æ€§**: æ‰€æœ‰æµ‹è¯•æ¡ˆä¾‹çš„æ¦‚ç‡å’Œéƒ½ç­‰äº 1.0
- âœ… **æ•°å­¦åˆç†æ€§**: ä¸åŒçš„ loc_S å€¼äº§ç”Ÿç¬¦åˆç›´è§‰çš„ç±»åˆ«é¢„æµ‹
- âœ… **å°ºåº¦æ•æ„Ÿæ€§**: scale_S å½±å“ä¸ç¡®å®šæ€§åˆ†å¸ƒï¼Œç¬¦åˆæŸ¯è¥¿åˆ†å¸ƒç‰¹æ€§
- âœ… **å¤šç±»åˆ«æ”¯æŒ**: æµ‹è¯•äº† 3ã€5ã€7 ç±»åˆ«çš„ç¦»æ•£æœ‰åºåˆ†ç±»ï¼Œå‡å·¥ä½œæ­£å¸¸

#### 5.4 æµ‹è¯•ç»“æœåˆ†æ

**âœ… åŠŸèƒ½éªŒè¯æˆåŠŸ**ï¼š
1. **æ··åˆæ¨¡å¼å·¥ä½œæ­£å¸¸**ï¼šä¸åŒç»´åº¦å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ¿€æ´»æ¨¡å¼
2. **ç¦»æ•£æœ‰åºæ¿€æ´»æœ‰æ•ˆ**ï¼šæˆåŠŸè¾“å‡ºæœ‰åºç±»åˆ«ï¼ˆ0-4 å¯¹åº” 1-5çº§ï¼‰
3. **æ•°å­¦ä¸€è‡´æ€§**ï¼šåº•å±‚çš„ S åˆ†å¸ƒå‚æ•°æ­£ç¡®ä¼ æ’­åˆ°å„ç§æ¿€æ´»å‡½æ•°
4. **å‚æ•°ç‹¬ç«‹æ€§**ï¼šæ¯ç§æ¿€æ´»æ¨¡å¼çš„å‚æ•°ç›¸äº’ç‹¬ç«‹

**ğŸ¯ å®é™…åº”ç”¨ä»·å€¼**ï¼š
- **5çº§è¯„åˆ†ç³»ç»Ÿ**ï¼šå¯ç”¨äºäº§å“è¯„ä»·ã€å†…å®¹è´¨é‡ç­‰
- **æƒ…æ„Ÿåˆ†æ**ï¼šæ”¯æŒå¤šçº§æƒ…æ„Ÿå¼ºåº¦åˆ†ç±»
- **ç½®ä¿¡åº¦è¯„ä¼°**ï¼šæä¾›ç»†ç²’åº¦çš„ä¸ç¡®å®šæ€§é‡åŒ–

**ğŸ“Š æ•°å­¦éªŒè¯äº®ç‚¹**ï¼š
- **æŸ¯è¥¿åˆ†å¸ƒCDF**ï¼šæ­£ç¡®å®ç°äº† CDF_Cauchy(c) = 1/2 + (1/Ï€)arctan((c - loc_S)/scale_S)
- **åŒºé—´æ¦‚ç‡è®¡ç®—**ï¼šP(Y=k) = CDF(C_{k+1}) - CDF(C_k) çš„å®ç°ç²¾ç¡®æ— è¯¯
- **è¾¹ç•Œå¤„ç†**ï¼šæ­£ç¡®å¤„ç†äº† -âˆ å’Œ +âˆ è¾¹ç•Œæƒ…å†µ
- **é˜ˆå€¼æ’åº**ï¼šè‡ªåŠ¨ç»´æŠ¤äº†æœ‰åºé˜ˆå€¼åºåˆ—çš„çº¦æŸ

---

### 6. æ¶æ„å†³ç­–çš„æ·±å±‚è€ƒè™‘

#### 6.1 æ•°å­¦çº¯ç²¹æ€§ç»´æŠ¤

**S ä½œä¸ºä¸­é—´è¡¨ç¤ºçš„ä»·å€¼**ï¼š
- **ç†è®ºå®Œæ•´æ€§**ï¼šS æ˜¯å› æœæ¨ç†ç†è®ºçš„æ ¸å¿ƒæ¦‚å¿µï¼Œå…·æœ‰ç‹¬ç«‹çš„æ•°å­¦æ„ä¹‰
- **æ¦‚å¿µæ¸…æ™°æ€§**ï¼šå½’å› (U) â†’ å†³ç­–(S) â†’ è¾“å‡º(Y) çš„é“¾æ¡ç¬¦åˆäººç±»è®¤çŸ¥
- **åˆ†å¸ƒç¨³å®šæ€§**ï¼šS ä¿æŒæŸ¯è¥¿åˆ†å¸ƒç‰¹æ€§ï¼Œæ”¯æŒè§£æè®¡ç®—

#### 6.2 æœªæ¥æ‰©å±•èƒ½åŠ›

**æ–°æ¿€æ´»æ¨¡å¼çš„æ·»åŠ **ï¼š
- **æ— ä¾µå…¥æ€§**ï¼šæ·»åŠ æ–°æ¨¡å¼ä¸éœ€è¦ä¿®æ”¹å› æœæ ¸å¿ƒ
- **å‘åå…¼å®¹**ï¼šç°æœ‰ä»£ç ç»§ç»­å·¥ä½œ
- **å®éªŒå‹å¥½**ï¼šå¯ä»¥å¿«é€ŸåŸå‹åŒ–æ–°çš„æ¿€æ´»å‡½æ•°

**æ½œåœ¨æ‰©å±•æ–¹å‘**ï¼š
```python
# æœªæ¥å¯èƒ½çš„æ¿€æ´»æ¨¡å¼
class ActivationMode(Enum):
    CLASSIFICATION = "classification"
    REGRESSION = "regression"
    ORDINAL = "ordinal"
    # æ½œåœ¨æ‰©å±•
    RANKING = "ranking"           # æ’åºä»»åŠ¡
    MULTI_LABEL = "multi_label"   # å¤šæ ‡ç­¾åˆ†ç±»
    SEQUENCE = "sequence"         # åºåˆ—è¾“å‡º
    STRUCTURED = "structured"     # ç»“æ„åŒ–è¾“å‡º
```

#### 6.3 æ€§èƒ½ä¸å¤æ‚åº¦è€ƒè™‘

**è®¡ç®—å¼€é”€**ï¼š
- **é¢å¤–å±‚æ•°**ï¼š+1 å±‚å‡½æ•°è°ƒç”¨
- **å†…å­˜ä½¿ç”¨**ï¼šä¸­é—´ S éœ€è¦å­˜å‚¨
- **è®­ç»ƒæ•ˆç‡**ï¼šå¯ä»¥åˆ†é˜¶æ®µè®­ç»ƒä¸åŒæ¨¡å—

**å¤æ‚åº¦æƒè¡¡**ï¼š
- **å¼€å‘å¤æ‚åº¦**ï¼šç¨å¾®å¢åŠ ï¼ˆéœ€è¦ç†è§£ä¸‰ä¸ªæ¨¡å—ï¼‰
- **ä½¿ç”¨å¤æ‚åº¦**ï¼šç®€åŒ–ï¼ˆæ¸…æ™°çš„æ¥å£åˆ†ç¦»ï¼‰
- **ç»´æŠ¤å¤æ‚åº¦**ï¼šé™ä½ï¼ˆæ¨¡å—åŒ–æ˜“äºè°ƒè¯•ï¼‰

---

### 7. å®é™…ç”Ÿäº§åº”ç”¨æŒ‡å¯¼

#### 7.1 æ¨èä½¿ç”¨æ¨¡å¼

**æ ‡å‡†åº”ç”¨**ï¼ˆæ¨èï¼‰ï¼š
```python
# å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½¿ç”¨å®Œæ•´çš„ CausalEngine
engine = CausalEngine(
    hidden_size=512,
    vocab_size=50000,
    activation_modes="classification"  # æˆ–æ··åˆæ¨¡å¼
)
outputs = engine(hidden_states)
```

**é«˜çº§åº”ç”¨**ï¼ˆå¤šä»»åŠ¡ï¼‰ï¼š
```python
# éœ€è¦å¤šä»»åŠ¡å­¦ä¹ æ—¶ï¼Œåˆ†ç¦»ä½¿ç”¨
engine = CausalEngine(..., apply_activation=False)
loc_S, scale_S = engine(hidden_states)['loc_S'], engine(hidden_states)['scale_S']

# ä¸ºä¸åŒä»»åŠ¡é…ç½®ä¸“é—¨çš„æ¿€æ´»å¤´
task_heads = {
    'generation': ActivationHead(vocab_size, "classification"),
    'sentiment': ActivationHead(5, "ordinal", ordinal_num_classes=5),
    'score': ActivationHead(1, "regression")
}
```

#### 7.2 è®­ç»ƒç­–ç•¥å»ºè®®

**è”åˆè®­ç»ƒ**ï¼š
```python
# ç®€å•åœºæ™¯ï¼šç«¯åˆ°ç«¯è®­ç»ƒ
loss = compute_loss(engine(input_ids), targets)
loss.backward()
```

**åˆ†é˜¶æ®µè®­ç»ƒ**ï¼š
```python
# å¤æ‚åœºæ™¯ï¼šå…ˆè®­ç»ƒå› æœæ ¸å¿ƒï¼Œå†å¾®è°ƒæ¿€æ´»å¤´
# é˜¶æ®µ1ï¼šé¢„è®­ç»ƒå› æœæ ¸å¿ƒ
for param in engine.activation.parameters():
    param.requires_grad = False

# é˜¶æ®µ2ï¼šå¾®è°ƒæ¿€æ´»å¤´
for param in engine.abduction.parameters():
    param.requires_grad = False
for param in engine.action.parameters():
    param.requires_grad = False
```

---

### 8. ç»“è®ºä¸æœªæ¥å±•æœ›

#### 8.1 å†³ç­–ç¡®è®¤

ç»è¿‡å…¨é¢çš„åˆ†æï¼Œ**ä¿æŒ ActivationHead ä½œä¸ºç‹¬ç«‹æ¨¡å—**æ˜¯æ­£ç¡®çš„æ¶æ„é€‰æ‹©ï¼š

1. **âœ… æ•°å­¦ç†è®ºæ¸…æ™°**ï¼šå®Œç¾ä½“ç°"å½’å›  â†’ å†³ç­– â†’ è¾“å‡º"çš„å› æœé“¾æ¡
2. **âœ… å·¥ç¨‹å®è·µä¼˜ç§€**ï¼šæ¨¡å—åŒ–è®¾è®¡æ”¯æŒçµæ´»ç»„åˆå’Œæ‰©å±•
3. **âœ… åŠŸèƒ½éªŒè¯æˆåŠŸ**ï¼šä¸‰ç§æ¿€æ´»æ¨¡å¼ï¼ˆåŒ…æ‹¬æ–°å¢çš„ç¦»æ•£æœ‰åºï¼‰å·¥ä½œæ­£å¸¸
4. **âœ… æœªæ¥æ‰©å±•å‹å¥½**ï¼šä¸ºåç»­åŠŸèƒ½æ‰©å±•æä¾›äº†è‰¯å¥½åŸºç¡€

#### 8.2 å®ç°é‡Œç¨‹ç¢‘

- **v2.0.0**: åŸºç¡€æ¨¡å—åŒ–æ¶æ„ âœ…
- **v2.0.1**: å¢å¼ºå‹å½’å› ç½‘ç»œ âœ…
- **v2.0.2**: ç¨³å®šæ€§ä¼˜åŒ– âœ…
- **v2.0.3**: æ¥å£å®Œå–„ âœ…
- **v2.0.4**: ç¦»æ•£æœ‰åºæ¿€æ´» âœ… **â† å½“å‰ç‰ˆæœ¬**

#### 8.3 æ¶æ„ä»·å€¼

è¿™ç§è®¾è®¡ä½¿ CausalEngine æˆä¸ºä¸€ä¸ªçœŸæ­£**æ¨¡å—åŒ–çš„å› æœæ¨ç†æ¡†æ¶**ï¼š
- **ç†è®ºä¸¥è°¨**ï¼šæ•°å­¦åŸºç¡€æ‰å®ï¼Œæ¦‚å¿µæ¸…æ™°
- **å·¥ç¨‹ä¼˜é›…**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†æ˜
- **å®ç”¨çµæ´»**ï¼šæ”¯æŒå¤šç§åº”ç”¨åœºæ™¯
- **æ‰©å±•å‹å¥½**ï¼šä¸ºæœªæ¥å‘å±•å¥ å®šåŸºç¡€

CausalEngine ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç®—æ³•å®ç°ï¼Œæ›´æ˜¯å› æœæ¨ç†ç†è®ºä¸å·¥ç¨‹å®è·µå®Œç¾ç»“åˆçš„å…¸èŒƒã€‚

---

## 9. å»ºè®®å“åº”çŠ¶æ€æ›´æ–°

### ğŸ¯ åŸå§‹éªŒè¯æŠ¥å‘Šå»ºè®®å¤„ç†æƒ…å†µ

æ ¹æ®ä¹‹å‰çš„ CausalEngine æ•°å­¦å®ç°ä¸€è‡´æ€§æŠ¥å‘Šä¸­æåˆ°çš„æ”¹è¿›å»ºè®®ï¼Œæˆ‘ä»¬çš„å“åº”çŠ¶æ€å¦‚ä¸‹ï¼š

#### âœ… å·²å®Œæˆçš„å»ºè®®

**1. ç¦»æ•£æœ‰åºæ¿€æ´»å®ç°**
- **åŸå»ºè®®**: "æ•°å­¦æ–‡æ¡£ä¸­æåˆ°çš„ç¬¬ä¸‰ç§æ¿€æ´»å‡½æ•°ï¼ˆç¦»æ•£æœ‰åºæ•°å€¼æ¿€æ´»ï¼‰å°šæœªå®ç°ï¼Œå»ºè®®å¯ä»¥åœ¨ ActivationHead ä¸­æ·»åŠ  ORDINAL æ¨¡å¼ï¼Œå®ç°åŒºé—´æ¦‚ç‡è®¡ç®—"
- **å®ŒæˆçŠ¶æ€**: âœ… **å·²å…¨é¢å®ç°**
- **å®ç°å†…å®¹**:
  - æ·»åŠ äº† `ActivationMode.ORDINAL` æšä¸¾å€¼
  - å®ç°äº†å®Œæ•´çš„åŒºé—´æ¦‚ç‡è®¡ç®—ï¼š$P(Y=k) = P(C_k < S \leq C_{k+1})$
  - æ”¯æŒä»»æ„æ•°é‡çš„æœ‰åºç±»åˆ«ï¼ˆ3ç±»ã€5ç±»ã€7ç±»ç­‰ï¼‰
  - é€šè¿‡äº†è¯¦ç»†çš„æ•°å­¦éªŒè¯ï¼Œæ‰‹åŠ¨è®¡ç®—ä¸è‡ªåŠ¨è®¡ç®—ç»“æœä¸€è‡´
  - æ¦‚ç‡åˆ†å¸ƒå’Œæ’ç­‰äº 1.0ï¼Œç¬¦åˆæ•°å­¦è¦æ±‚
- **éªŒè¯ç»“æœ**: å·²åœ¨ v2.0.4 ç‰ˆæœ¬ä¸­å‘å¸ƒå¹¶å®Œå…¨éªŒè¯

**2. æ–‡æ¡£å®Œå–„**
- **åŸå»ºè®®**: "å¯ä»¥åœ¨ä»£ç æ³¨é‡Šä¸­æ·»åŠ æ›´å¤šæ•°å­¦å…¬å¼å¼•ç”¨ï¼Œæ–¹ä¾¿åç»­ç»´æŠ¤"
- **å®ŒæˆçŠ¶æ€**: âœ… **å·²æ˜¾è‘—æ”¹è¿›**
- **æ”¹è¿›å†…å®¹**:
  - **AbductionNetwork**: æ·»åŠ äº†å®Œæ•´çš„æ•°å­¦æ¡†æ¶æ³¨é‡Šï¼ŒåŒ…æ‹¬ä½ç½®ç½‘ç»œå’Œå°ºåº¦ç½‘ç»œçš„æ•°å­¦å®šä¹‰
  - **ActionNetwork**: è¯¦ç»†æ³¨é‡Šäº†ä¸‰ç§å™ªå£°æ¨¡å¼çš„æ•°å­¦å…¬å¼å’ŒæŸ¯è¥¿åˆ†å¸ƒçº¿æ€§ç¨³å®šæ€§
  - **ActivationHead**: ä¸ºä¸‰ç§æ¿€æ´»æ¨¡å¼æ·»åŠ äº†è¯¦ç»†çš„æ•°å­¦æ¨å¯¼è¿‡ç¨‹
  - **CausalEngine**: è¡¥å……äº†å®Œæ•´å› æœæ¨ç†æµç¨‹çš„æ•°å­¦æè¿°
  - **CauchyMath**: å¢åŠ äº†æŸ¯è¥¿åˆ†å¸ƒæ ¸å¿ƒæ€§è´¨å’Œçº¿æ€§ç¨³å®šæ€§çš„æ•°å­¦è¯´æ˜

### ğŸ“Š æ•°å­¦å…¬å¼æ³¨é‡Šè¦†ç›–æƒ…å†µ

| æ¨¡å— | æ•°å­¦å…¬å¼è¦†ç›–åº¦ | å…³é”®å…¬å¼ |
|------|----------------|----------|
| **AbductionNetwork** | âœ… å®Œæ•´ | $X \rightarrow U \sim \text{Cauchy}(\mu_U, \gamma_U)$ |
| **ActionNetwork** | âœ… å®Œæ•´ | $U \rightarrow S \sim \text{Cauchy}(\text{loc}_S, \text{scale}_S)$ |
| **ActivationHead** | âœ… å®Œæ•´ | åˆ†ç±»ï¼š$P(S_k > C_k)$ï¼Œå›å½’ï¼š$y_k = a_k \cdot S_k + b_k$ï¼Œæœ‰åºï¼š$P(Y=k)$ |
| **CauchyMath** | âœ… å®Œæ•´ | çº¿æ€§ç¨³å®šæ€§ï¼š$aX + b \sim \text{Cauchy}(a\mu + b, \|a\|\gamma)$ |

### ğŸ‰ å»ºè®®å“åº”å®Œæˆåº¦

- **ç¦»æ•£æœ‰åºæ¿€æ´»**: âœ… 100% å®Œæˆ
- **æ•°å­¦å…¬å¼æ³¨é‡Š**: âœ… 100% å®Œæˆ
- **æ¶æ„æ–‡æ¡£**: âœ… 100% å®Œæˆï¼ˆæœ¬æ–‡æ¡£ï¼‰
- **æµ‹è¯•éªŒè¯**: âœ… 100% å®Œæˆ

### ğŸ“ˆ ç‰ˆæœ¬æ¼”è¿›è¿½è¸ª

- **v2.0.0-v2.0.3**: åŸºç¡€æ¶æ„å®Œå–„
- **v2.0.4**: â­ **ç¦»æ•£æœ‰åºæ¿€æ´» + æ•°å­¦æ³¨é‡Šå®Œå–„**
- **æœªæ¥ç‰ˆæœ¬**: å‡†å¤‡å¥½æ‰©å±•æ›´å¤šæ¿€æ´»æ¨¡å¼ï¼ˆå¦‚ RANKING, MULTI_LABEL ç­‰ï¼‰

æ‰€æœ‰åŸå§‹å»ºè®®å‡å·²å¾—åˆ°å…¨é¢å“åº”å’Œå®ç°ã€‚CausalEngine ç°åœ¨æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æ•°å­¦ä¸¥è°¨ã€æ–‡æ¡£è¯¦å°½çš„å› æœæ¨ç†æ¡†æ¶ã€‚ 