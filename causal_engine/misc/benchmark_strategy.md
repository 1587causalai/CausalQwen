# CausalEngine 基准测试协议 (Benchmark Experiment Protocol)

## 1. 引言与实验目标

### 1.1 实验目标
本文档为 CausalEngine 在标准基准数据集上的首次系统性测试，提供官方的、可复现的实验协议。其核心目标包括：
1.  **性能评估**: 在4个分类和4个回归标准数据集上，系统性地评估CausalEngine相对于传统基线模型的性能。
2.  **建立基线**: 为后续所有的模型改进、消融实验和理论探索，建立一个可靠、可解释的性能基准。
3.  **假设验证**: 科学地、分阶段地验证"让模型自主学习全局噪声"这一核心假设的有效性。

### 1.2 指导原则
本次实验所有配置均遵循**"科学对照"**原则。为了实现清晰的因果归因和结果的可解释性，我们将模型的机制参数（如`b_noise`）视为**固定的、可控的实验条件**或**明确的探索变量**，而非模糊的、混合的优化目标。

---

## 2. 模型架构与参数定义

CausalEngine 的核心架构包含两大阶段：**归因 (Abduction)** 和 **行动 (Action)**。其中，行动阶段内部又分为"决策得分生成"和"任务激活"两个步骤。

### 2.1 归因网络 (Abduction Network)
该模块负责从证据 $z$ 推断代表个体的柯西分布参数。
-   **数学公式**:
    $$ \text{loc}_{U} = W_{\text{loc}} \cdot z + b_{\text{loc}} $$
    $$ \text{scale}_{U} = \text{softplus}(W_{\text{scale}} \cdot z + b_{\text{scale}}) $$
-   **可学习参数**: `W_loc`, `b_loc`, `W_scale`, `b_scale`。

### 2.2 行动网络 (Action Network)
该模块应用普适因果律，将个体分布 $U$ 映射到通用的、任务无关的决策得分 $S$。
-   **数学公式**:
    $$ \text{loc}_{S_k} = W_{\text{cls},k} \cdot \text{loc}_{U} + b_{\text{cls},k} $$
    $$ \text{scale}_{S_k} = (\text{scale}_{U} + |\mathbf{b}_{\text{noise}}|) \cdot |W_{\text{cls},k}| $$
-   **核心参数**:
    -   `W_cls`, `b_cls`: 代表普适因果律的**可学习权重**。
    -   `b_noise`: 代表全局环境噪声强度的**可配置参数**。

### 2.3 任务激活头 (Task Activation Heads)
该模块是行动阶段的最后一步，负责将通用的决策得分 $S$ 转化为特定任务的输出。不同的任务使用不同的激活头。

#### 2.3.1 分类任务激活头 (Classification Head)
-   **机制**: 对每个决策得分 $S_k$ 应用 OvR (One-vs-Rest) 阈值判断。
    $$ P_{k} = P(S_k > C_{\text{ovr}}) = \frac{1}{2} + \frac{1}{\pi} \arctan\left(\frac{\text{loc}_{S_k} - C_{\text{ovr}}}{\text{scale}_{S_k}}\right) $$
-   **核心参数**:
    -   `C_ovr`: 全局决策阈值，是一个**可配置参数**。

#### 2.3.2 回归任务激活头 (Regression Head)
-   **机制**: 对每个决策得分 $S_k$ 应用一个专属的线性变换。
    $$ Y_k \sim \text{Cauchy}(w_k \text{loc}_{S_k} + b_k, |w_k| \text{scale}_{S_k}) $$
-   **核心参数**:
    -   `w_k`, `b_k`: 每个回归目标专属的**固定参数**（本次实验设为 `w_k=1.0`, `b_k=0.0`）。

---

## 3. 实验协议

我们设计了两组平行的对比实验，通过控制 `b_noise` 是否参与梯度更新，来全面理解噪声对模型效果的影响。

### 3.1 实验组A：固定噪声强度实验 (Fixed Noise Experiments)

**目标**: 通过测试不同的固定噪声强度，理解噪声如何影响模型性能。

**核心参数配置**:
| 参数类别 | 参数名 | **配置角色** | **值/状态** |
| :--- | :--- | :--- | :--- |
| **网络权重** | `Abduction`/* <br> `Action`/* | **可学习权重** | Xavier/Kaiming 初始化 |
| **实验变量** | `b_noise` | **固定值（requires_grad=False）** | 见下表 |
| **固定超参数** | `C_ovr` | **固定超参数** | `0.0` |
| | `w_k`, `b_k` (回归头) | **固定超参数** | `1.0`, `0.0` |

**噪声强度对比实验设计**:
为全面理解噪声如何影响模型表现，我们将测试多个固定的 `b_noise` 值：
| `b_noise` 值 | 含义 | 预期效果 |
| :--- | :--- | :--- |
| `0.01` | 低噪声 | 高置信度，可能过拟合 |
| `0.05` | 中低噪声 | 较高置信度 |
| `0.1` | **标准噪声（默认）** | 平衡的不确定性表达 |
| `0.2` | 中高噪声 | 保守预测 |
| `0.5` | 高噪声 | 高度不确定，可能欠拟合 |

通过这组对比实验，我们可以：
1. 绘制噪声强度-性能曲线，理解其非线性关系
2. 识别不同数据集的最优噪声区间
3. 理解噪声作为正则化机制的作用

**训练超参数**:
| 参数 | 值 | 说明 |
| :--- | :--- | :--- |
| `Optimizer` | `AdamW` | |
| `Learning Rate` | `1e-4` | 线性 warm-up (前10% steps)，然后 cosine decay |
| `Weight Decay` | `0.01` | |
| `Epochs` | `100` | |
| `Early Stopping`| `True` | Patience: 10 epochs, 监控验证集损失 |
| `Batch Size` | `64` | |

**实验控制**:
通过设置 `b_noise.requires_grad = False`，确保噪声强度在训练过程中保持固定，从而能够准确评估不同噪声水平对模型性能的影响。

### 3.2 实验组B：自适应噪声学习实验 (Adaptive Noise Learning)

**目标**: 验证让模型自主学习全局环境噪声的有效性。

**核心参数配置**:
| 参数类别 | 参数名 | **配置角色** | **值/状态** |
| :--- | :--- | :--- | :--- |
| **网络权重** | `Abduction`/* <br> `Action`/* | **可学习权重** | Xavier/Kaiming 初始化 |
| | `b_noise` | **可学习权重（requires_grad=True）** | 初始化为 0.1 |
| **固定超参数** | `C_ovr` | **固定超参数** | `0.0` |
| | `w_k`, `b_k` (回归头) | **固定超参数** | `1.0`, `0.0` |

**实现细节**：
- 使用 `nn.Parameter(torch.tensor([0.1]))` 创建可学习的 `b_noise`
- 在优化器中包含 `b_noise` 参数
- 可以考虑对 `b_noise` 使用不同的学习率（如主网络的 1/10）

**训练超参数**:
| 参数 | 值 | 说明 |
| :--- | :--- | :--- |
| `Optimizer` | `AdamW` | |
| `Learning Rate` | `1e-4` | 线性 warm-up (前10% steps)，然后 cosine decay |
| `Weight Decay` | `0.01` | |
| `Epochs` | `100` | |
| `Early Stopping`| `True` | Patience: 10 epochs, 监控验证集损失 |
| `Batch Size` | `64` | |

**实验控制**:
通过设置 `b_noise.requires_grad = True`，允许模型自主学习最适合当前任务的噪声强度，探索模型解耦个体不确定性与全局不确定性的能力。

---

## 4. 评估与分析

### 4.1 评估指标
-   **分类任务**: Accuracy, F1-Score (Macro), Precision, Recall
-   **回归任务**: Mean AbsoluteError (MAE), Root Mean Squared Error (RMSE), Median Absolute Error (MdAE), MSE, R²

### 4.2 对比分析
实验报告应包含以下核心对比：

1. **噪声强度影响分析**：
   - 对比实验组A中不同固定噪声值（0.01, 0.05, 0.1, 0.2, 0.5）的性能
   - 绘制性能-噪声曲线，分析最优噪声区间

2. **固定 vs. 自适应噪声**：
   - 对比实验组A的最优固定噪声 vs. 实验组B的自适应学习
   - 分析模型学到的噪声值是否合理
   - 评估自适应学习是否带来性能提升

3. **CausalEngine vs. 传统基线**：
   - 将CausalEngine的最佳配置与标准MLP基线进行对比
   - 验证因果架构的有效性

---

## Appendix: 核心设计理念问答 (Core Design Rationale FAQ)

### Q1: CausalEngine特有的参数体系是什么？

CausalEngine引入了两组全新的参数，用于实现其核心的因果推理机制：

1.  **归因网络 (`AbductionNetwork`)**:
    *   `W_loc`, `b_loc`: 推断个体群体**中心** `μ`。
    *   `W_scale`, `b_scale`: 推断个体群体**多样性** `γ`。
2.  **行动网络与任务激活头 (`ActionNetwork` & `TaskActivation Heads`)**:
    *   `W_cls`, `b_cls`: 代表**普适因果律 `f`**（可学习权重）。
    *   `b_noise`: 代表**全局环境噪声 `ε`** 的强度（可配置参数）。
    *   `C_ovr`: 分类任务的**全局决策阈值**（固定超参数）。
    *   `w_k`, `b_k`: 回归任务的**专属线性变换参数**（固定超参数）。

在本次实验中，只有归因网络和行动网络的权重（`W_loc`, `b_loc`, `W_scale`, `b_scale`, `W_cls`, `b_cls`）是可学习的。`b_noise` 根据实验阶段可以是固定超参数或可学习权重。而所有任务激活头的参数（`C_ovr`, `w_k`, `b_k`）在本次实验中都是固定超参数。

### Q2: 为什么要设计固定噪声和自适应噪声两组实验？

这种平行实验设计体现了**控制变量**的科学方法：

> **通过简单地控制 `b_noise.requires_grad` 的 True/False，我们可以清晰地评估噪声设置对模型效果的影响。**

这个设计有三个关键优势：
1. **实验控制的优雅性**: 只需要一个布尔开关就能在两种模式间切换，代码实现极其简洁。
2. **结果的可比性**: 两组实验除了 `b_noise` 是否可学习外，其他所有设置完全相同，确保了对比的公平性。
3. **科学洞察的深度**: 固定噪声实验让我们理解"噪声如何影响性能"，自适应实验让我们理解"模型需要多少噪声"。

### Q3: `b_noise` 和 `W_cls` 的功能不会冗余吗？为什么还要探索 `b_noise` 的可学习性？

这是一个非常深刻的问题。`b_noise` 并非冗余，而是一个**逻辑上必要、用于解耦的关键参数**。

`W_cls` 和 `b_noise` 捕捉了两个完全不同层面的信息：
-   **`W_cls` 是"局部"和"具体"的**：它代表了从个体特征到**每一个具体词汇**的映射规则。
-   **`b_noise` 是"全局"和"抽象"的**：它代表了任务环境**整体的、与具体词汇无关的**固有不确定性。

让 `b_noise` 可学习的实验，其目的在于探索模型**解耦"具体知识"和"环境属性"**的能力。如果模型能学到一个更"纯粹"的 `W_cls`（只负责语义关联），同时用一个独立的 `b_noise` 来学习任务的整体不确定性，那么它就可能获得一个更鲁棒、更可解释的内部表示。这正是自适应噪声实验想要验证的核心科学问题。 

### Q4: 为什么要在实验组A中测试多个固定噪声强度？

这个实验设计体现了**"先理解，后优化"**的科学研究方法论。通过系统地测试不同的固定噪声强度（0.01 到 0.5），我们可以获得三个层次的认知：

1. **现象层面的认知**：了解噪声强度如何影响模型在不同数据集上的表现，绘制出性能-噪声曲线。这可能揭示出有趣的非线性关系，比如存在一个"最优噪声区间"。

2. **机制层面的认知**：理解噪声在模型决策中扮演的角色。低噪声可能导致过于自信的预测（过拟合），高噪声可能导致过于保守的预测（欠拟合）。这帮助我们理解 `b_noise` 作为正则化机制的本质。

3. **方法论层面的认知**：固定噪声实验的结果为自适应学习提供了明确的参照系。我们可以回答：
   - 模型自主学到的噪声强度是否落在我们预期的最优区间内？
   - 自适应学习是否真的优于手动调参找到的最优固定值？
   - 不同数据集是否需要不同的噪声强度，这是否反映了任务的内在特性？

这种平行对比实验设计，让我们对噪声如何影响模型表现有了**全面的认知**，而不仅仅是一个黑盒优化的结果。 