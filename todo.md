# 项目文档与代码深度分析计划

根据您的反馈，我们调整计划的重心，使其完全专注于对当前项目实现的**深度理解、验证和文档化**。本计划旨在通过多维度的分析，确保项目的理论、代码和实验结果三者之间形成一个清晰、准确、可验证的闭环。


- 如果每一步一步一步的去完成，才进行下一步， 会极大地拖慢我们的进度
- 所以我们需要反事实工作法。


所谓的反事实工作反就是假设(想象)相关的步骤都已经完成迅速的进行下一步。






---

## 阶段零：建立共识与项目蓝图 (Phase 0: Establish Blueprint & Consensus)

**目标**：在开始任何具体任务前，确保我们对整个项目的结构、每个组件的职责有一个统一且清晰的认识。

- [ ] **任务 0.1：理解项目蓝图**
  - **行动**: 仔细阅读并理解 `design-docs/PROJECT_BLUEPRINT.md` 文件。
  - **验收标准**: 对项目地图形成清晰的认知，并认同其中对各个组件的职责划分。这是后续所有工作的基础。

---

## 阶段一：基础审计与深度结果分析 (Phase 1: Foundational Audit & Deep Result Analysis)

**目标**：严格验证当前实验结果的准确性，并基于现有数据，从多个角度深入分析模型的核心行为，为后续的文档撰写提供坚实、可靠的素材。

- [ ] **任务 1.1：完整复现消融实验**

  - **行动**: 重新运行 `src/run_experiments.py ablation`。
  - **验收标准**: 生成的摘要指标（F1, MAE, PICP, ECE）与 `qwen_finetuning_report.md` 中的表格完全一致，确保结果的可复现性。
- [ ] **任务 1.2：评估指标实现的源码审计**

  - **行动**: 审查 `src/evaluation/evaluator.py` 中关键指标（尤其是 `reg_picp` 和 `calib_ece`）的计算逻辑。
  - **验收标准**: 确认其实现与学术界的标准定义一致，并为代码添加注释，解释其计算原理。
- [ ] **任务 1.3：原始实验数据深度分析**

  - **行动**: 编写一个新的分析脚本，直接读取实验产出的 `.json` 原始结果文件，进行比报告中更深入的可视化分析。
  - **具体分析点**:
    - 绘制**回归误差的分布图**，观察 `full_model` vs `no_cauchy` 在极端值数据集上的误差分布差异。
    - 按数值范围分箱（binning），分析模型在不同数量级上的性能表现。
    - 绘制置信度与准确率的校准曲线图（Reliability Diagram）。
  - **验收标准**: 生成一组信息量更丰富的分析图表，为重写实验报告提供素材。
- [ ] **任务 1.4：个体因果表征 `U` 的可解释性分析**

- **行动**: 修改评估代码，保存推断出的个体因果表征分布参数（`loc_U`, `scale_U`），并进行可视化分析。
  - **具体分析**:
    - 使用 t-SNE 或 PCA 对 `loc_U` 向量进行降维可视化，观察来自不同数据集（基础、问答、极端值）的样本是否形成有意义的聚类。
    - 分析并对比不同样本的 `scale_U`（不确定性）的大小，验证其是否与任务难度相关。
  - **验收标准**: 生成个体因果表征空间的可视化图表，为深入理解"推断-行动"范式提供直观证据。

---

## 阶段二：代码与理论映射及文档化 (Phase 2: Code-to-Theory Mapping & Documentation)

**目标**：创建一系列全新的、高度详细的实现文档，清晰地建立起从顶层数学原理到底层代码实现的桥梁，确保当前的代码忠实地执行了设计思想。

- [ ] **任务 2.1：创建 `docs/implementation` 目录**

  - **行动**: 在 `docs/`下新建一个 `implementation/` 目录，用于存放所有新的代码实现详解文档。
  - **验收标准**: 目录创建成功。
- [ ] **任务 2.2：撰写 `CauchyLinear` 层实现详解**

  - **行动**: 在 `docs/implementation/`下创建 `cauchy_linear.md`。
  - **内容**: 详细解释 `CauchyLinear` 类如何实现柯西分布的线性变换。文档需包含：相关的数学公式、带注释的代码片段、以及对 `forward` 方法中 `loc` 和 `scale` 变换逻辑的逐行解释。
- [ ] **任务 2.3：撰写 OvR 分类头实现详解**

  - **行动**: 在 `docs/implementation/`下创建 `ovr_classifier.md`。
  - **内容**: 解释模型如何实现 OvR 分类。内容需覆盖：从决策分数 `S_k` 到概率 `P(S_k > θ)` 的计算过程、`compute_probabilities` 函数的作用、以及为何使用 `BCEWithLogitsLoss` 可以有效训练OvR模型。
- [ ] **任务 2.4：撰写门控损失函数实现详解**

  - **行动**: 在 `docs/implementation/`下创建 `gated_loss.md`。
  - **内容**: 详细拆解门控损失函数的代码实现。将代码与数学公式 `P(<NUM>) * I(...) * L_cauchy` 相对应，解释其如何实现"先分类，后回归"的动态学习过程。
- [ ] **任务 2.5：撰写整体数据流与模型架构详解**

  - **行动**: 在 `docs/implementation/`下创建 `architecture_overview.md`。
  - **内容**: 绘制一幅 Mermaid 流程图或时序图，清晰地展示一个数据样本从输入到最终损失计算的完整前向传播路径。图中应标注出关键模块，如 `FeatureNetwork`, `AbductionNetwork`, `ActionNetwork` 等。

---

## 阶段三：项目级文档综合与润色 (Phase 3: Synthesis & Polishing of Project-Level Docs)

**目标**：将前两阶段的验证结果和深度洞察，全面、准确地反映到项目的所有高级文档中，最终形成一套内容一致、逻辑严密、描述精准的文档体系。

- [ ] **任务 3.1：重写实验报告**

  - **行动**: 基于阶段一的发现，重写 `docs/experiments/qwen_finetuning_report.md`。
  - **内容**: 用经过验证的、可复现的数据替换原有表格。集成阶段1.3和1.4中生成的新图表（如误差分布图、t-SNE图），并提供深入的图表解读。报告的分析应更侧重于"数据如何验证了我们的理论"，而不是简单的性能好坏。
- [ ] **任务 3.2：精炼核心设计文档**

  - **行动**: 小幅修改 `design-docs/math/mathematical_foundations.md` 和 `design-docs/experiments/experiment_design.md`。
  - **内容**: 在这些理论文档的关键部分（如讲解柯西线性变换、OvR分类处），**添加指向阶段二中创建的新实现文档的交叉引用链接**。例如，"(该公式的具体代码实现，请参见 `docs/implementation/cauchy_linear.md`）"。
- [ ] **任务 3.3：完善代码内文档（Docstrings）**

  - **行动**: 系统性地检查和完善 `src/` 目录下核心模块和函数的 docstrings。
  - **内容**: 确保 `CausalLM`, `CauchyLinear`, `
