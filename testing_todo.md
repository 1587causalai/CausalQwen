# CausalQwen 数学验证测试计划

## 目标
基于 `docs/mathematical_foundations.md` 的数学描述，验证每个核心数学概念的实现正确性。

---

## 📊 数学驱动的测试路径

```
数值感知嵌入 → 特征提取(串行) → 因果推断(并行) → 行动决策(并行) → 门控损失
```

---

## 🔍 数学概念验证清单

### 阶段1: 数值感知的统一表示验证
- [ ] **任务 1.1：数值编码函数 φ(v) 测试**
  - 验证 `φ(v) = sign(v) · ln(1 + |v|) · e`
  - 验证关键性质：`φ(0) = 0`
  - 测试不同数值范围的编码结果
  - 验证数值稳定性（大数值输入）

- [ ] **任务 1.2：增强嵌入 e_i 测试**
  - 验证 `e_i = embed(x_i) + φ(v_i)`
  - 测试 `<NUM>` 位置：确保数值信息正确融入
  - 测试非数值位置：确保自然退化为 `embed(x_i)`
  - 验证批处理和序列维度正确

### 阶段2: 特征提取阶段（串行性质）验证
- [ ] **任务 2.1：Transformer 特征提取测试**
  - 输入：增强嵌入 `(e_1, ..., e_S)`
  - 输出：特征序列 `z = (z_1, ..., z_S)`
  - 验证自注意力机制的位置间依赖关系
  - 确认此阶段**不可并行**的性质

### 阶段3: 因果推断阶段（并行性质）验证
- [ ] **任务 3.1：个体因果表征 U 的分布测试**
  - 验证 `U_i | z_i ~ Cauchy(loc(z_i), scale(z_i))`
  - 测试柯西分布参数的合理性（loc 无约束，scale > 0）
  - 验证位置间的**条件独立性**：`P(U_i | z) = P(U_i | z_i)`

- [ ] **任务 3.2：柯西分布线性稳定性测试**
  - 验证核心数学性质：`Y = aU + b ~ Cauchy(aμ + b, |a|γ)`
  - 测试线性变换后的分布参数计算
  - 验证**无需采样**即可进行前向传播

### 阶段4: 行动决策阶段（并行性质）验证
- [ ] **任务 4.1：分类决策分数测试**
  - 验证 `S_{k,i} = A_k · U_i + B_k` 的线性变换
  - 利用柯西分布线性性质计算 `S_{k,i}` 的分布参数
  - 验证OvR分类概率公式：`P_{k,i} = 1/2 + (1/π)arctan((loc_S - C_k)/scale_S)`

- [ ] **任务 4.2：回归值测试**
  - 验证 `Y_i = W · U_i + b` 的线性变换
  - 测试回归值的柯西分布参数计算
  - 验证位置间并行计算的独立性

### 阶段5: 门控损失函数验证
- [ ] **任务 5.1：门控回归损失测试**
  - 验证公式：`L_reg_gated,i = m_i · (α + (1-α) · P_<NUM>,i) · L_cauchy_nll,i`
  - 测试数值掩码 `m_i` 的正确应用
  - 验证门控系数 `α` 的作用（1.0=无门控，0.0=完全门控）
  - 测试只有 `<NUM>` 位置参与回归损失

- [ ] **任务 5.2：总损失计算测试**
  - 验证 `L_total = Σ(L_cls,i + λ · L_reg_gated,i)`
  - 测试分类损失和回归损失的平衡
  - 验证梯度可以正确反向传播

### 阶段6: 并行性和数学性质综合验证
- [ ] **任务 6.1：条件独立性验证**
  - 验证给定 `z` 后，`P(U_i, S_{k,i}, Y_i | z) = P(U_i, S_{k,i}, Y_i | z_i)`
  - 测试位置间计算的真正独立性
  - 验证向量化计算的数学等价性

- [ ] **任务 6.2：端到端数学一致性测试**
  - 验证从输入到输出的所有数学变换
  - 测试采样预测 vs 分布参数预测的一致性
  - 验证反事实推理能力

---

## 🧮 关键数学性质检查清单

### 柯西分布性质
- [ ] 线性封闭性：`Y = aU + b ~ Cauchy(aμ + b, |a|γ)`
- [ ] 参数有效性：`scale > 0` 始终成立
- [ ] 分布计算无需采样

### 数值编码性质  
- [ ] 零值退化：`φ(0) = 0`
- [ ] 符号保持：`sign(φ(v)) = sign(v)`
- [ ] 数值稳定性：大数值不会导致溢出

### 并行化性质
- [ ] 特征提取阶段：串行，有位置依赖
- [ ] 因果推断阶段：并行，条件独立
- [ ] 行动决策阶段：并行，位置独立

### 门控机制性质
- [ ] 数值掩码正确：只有 `<NUM>` 位置有回归损失
- [ ] 门控系数作用：控制预测置信度对损失的影响
- [ ] 概率范围：所有概率值在 [0,1] 区间

---

## 📝 数学验证记录模板

```bash
python -m pytest tests/ -v
```

### 阶段1 - 数值编码
- [x] φ(0) = 0: ✓ (差异范数: 0.0000000000)
- [x] φ(v) 数值稳定性: ✓ (1e+12处理正常)  
- [x] 增强嵌入形状: [B, S, H] = [2, 4, 64]
- [x] 符号保持性质: ✓ (所有测试值通过)
- [x] 单调性验证: ✓ (正数严格递增)
- [x] 网络集成效果: ✓ (数值影响特征)
- [ ] 发现问题: 无

### 阶段2 - 特征提取
- [x] 输入形状: [B, S, H] = [1-4, 5-20, 128] ✓
- [x] 输出形状: [B, S, H] = 完全匹配 ✓ 
- [x] 位置依赖性确认: ✓ (MockNetwork限制：仅修改位置受影响)
- [x] 数值感知一致性: ✓ (差异范数 0.6-0.7)
- [x] 特征分布性质: ✓ (均值≈0, std≈0.09)
- [x] 梯度流动性: ✓ (<NUM>位置梯度≠0)
- [ ] 发现问题: MockNetwork无真正自注意力机制（预期行为）

### 阶段3 - 归因推断 (Abduction)
- [x] 柯西分布参数: loc无约束, scale>0 ✓ (范围[0.11, 10.22])
- [x] 条件独立性: P(U_i|z) = P(U_i|z_i) ✓ (完美验证)
- [x] 线性稳定性: Y=aU+b的分布计算 ✓ (差异=0.00000000)
- [x] 并行计算一致性: ✓ (批处理vs逐个差异<1e-5)
- [x] 分布参数统计: ✓ (loc均值≈0, scale合理范围)
- [ ] 发现问题: 无

### 阶段4 - 行动决策  
- [x] 线性变换性质: ✓ (S=A·U+B, Y=W·U+b 正确实现)
- [x] OvR分类概率公式: ✓ (P=1/2+(1/π)arctan完全正确)
- [x] 分类概率范围: [0,1] ✓ (所有测试情况通过)
- [x] 位置间独立性: ✓ (完美验证：只有修改位置受影响)
- [x] 预测一致性: ✓ (回归完全一致，分类67%匹配率)
- [x] 梯度流动性: ✓ (支持反向传播)
- [x] 数学边界情况: ✓ (极端值稳定处理)
- [ ] 发现问题: 序列处理导致的轻微预测差异(可接受)

### 阶段5 - 门控损失
- [x] 柯西负对数似然: ✓ (L=log(π·scale)+log(1+z²)完全正确)
- [x] 门控机制公式: ✓ (α+(1-α)·P_NUM所有情况验证)
- [x] 数值掩码应用: ✓ (只有<NUM>位置参与损失)
- [x] 门控回归损失: ✓ (完整公式正确实现)
- [x] 总损失组成: ✓ (L_total=Σ(L_cls+λ·L_reg)一致)
- [x] 梯度性质: ✓ (支持反向传播)
- [x] 数学性质: ✓ (完美预测=log(π), 误差单调性)
- [ ] 发现问题: API参数顺序(loc,scale,target)与PyTorch惯例不符

### 阶段6 - 端到端数学一致性验证 
- [x] 完整数据流验证: ✓ (输入→编码→特征→推断→决策→输出全流程)
- [x] 位置级别并行性: ✓ (逐位置vs完整序列差异<1e-5)
- [x] 采样vs确定性一致性: ✓ (1000次采样中位数差异<2.0)
- [x] 反事实推理能力: ✓ (相同文本+不同数值→不同预测)
- [x] 损失计算一致性: ✓ (端到端vs手动计算差异=0.0)  
- [x] 梯度流完整性: ✓ (输入→损失梯度范数0.032729)
- [x] 数学不变量保持: ✓ (φ(0)=0, 数值敏感性>0.001)
- [x] 发现问题: MockNetwork数值感知改进，损失接口统一 