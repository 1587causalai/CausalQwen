# CausalQwen 数学实现全面测试指南

本文档提供一个全新的、更加严格的测试框架，专门用于验证 CausalQwen 中每个数学组件的正确实现。

## 🎯 核心测试原则

1. **数学精确性优先**：每个测试必须直接对应数学公式
2. **隔离测试**：每个组件独立测试，避免级联错误
3. **边界条件全覆盖**：特别关注零值、极值、特殊情况
4. **数值稳定性验证**：检查浮点运算的精度和稳定性
5. **维度一致性检查**：确保张量形状在整个流程中保持正确

## 📋 测试清单概览

### 第一部分：基础组件测试
- [x] 数值编码函数 φ(v) 的完整验证
- [x] 增强嵌入计算的精确性测试
- [x] 词汇表扩展的正确性验证

### 第二部分：分布计算测试
- [x] 柯西分布参数的有效性验证
- [x] 线性变换的数学精确性测试
- [x] CDF 计算的数值准确性

### 第三部分：网络组件测试
- [x] 归因网络的初始化验证
- [x] 行动网络的权重迁移测试
- [ ] OvR 阈值的影响分析

### 第四部分：损失函数测试
- [x] 柯西负对数似然的精确计算
- [ ] 门控机制的边界情况
- [ ] 梯度流的正确性验证

### 第五部分：端到端集成测试
- [x] 完整前向传播的数值验证
- [x] 从文本到分类损失的完整流程验证
- [ ] 采样模式的一致性测试
- [ ] 批处理的正确性验证

### 第六部分：实验流程验证
- [x] `basic` 实验完整执行
- [ ] 训练、评估、报告流程健全性

### 第七部分：模块化流程图验证
- [x] 数值感知嵌入 (对应图2)
- [x] 因果核心流程 (对应图3)



## 测试进展


我已经完成了一系列系统性的单元和集成测试，以确保 CausalQwen 模型核心架构的数学正确性。我的测试进展如下：

1.  **验证了数值嵌入层 (`Numerical Aware Embedding`)**：我首先通过 `test_numerical_aware_embedding.py` 脚本，以流程图的方式验证了从原始文本输入到增强嵌入（`enhanced_embeddings`）的完整转换过程。测试结果表明，数值的提取、编码（`φ(v)`）以及与基础词元嵌入的融合完全符合设计，且只在 `<NUM>` token 的位置生效。

2.  **独立验证了核心网络模块**：接着，我通过 `test_abduction_network.py` 和 `test_action_network.py` 这两个独立的验证脚本，分别对归因网络（Abduction Network）和行动网络（Action Network）进行了白盒测试。结果确认了：
    *   **归因网络**的初始化能够正确实现恒等映射，并为因果尺度（`scale_U`）赋予一个符合预期的、具有高不确定性的柯西先验。
    *   **行动网络**能够成功地从预训练的 `lm_head` 继承知识，并正确地将输入的因果尺度（`scale_U`）线性传递到分类和回归的输出尺度（`scale_S`, `scale_Y`）上。

3.  **验证了核心损失函数**：我通过 `scripts/test_classification_loss.py` 脚本，对核心的 `ovr_classification_loss` 函数进行了白盒测试。通过在脚本内精确复现其数学逻辑，我验证了模型从概率计算到最终损失值的整个流程与数学设计完全一致。

4.  **验证了端到端的核心数据流**：我运行了 `test_causal_core.py`，这个脚本将增强嵌入、特征提取、归因和行动网络串联起来，验证了从 `e` -> `z` -> `U` -> `(S, Y)` 的核心数据流。

5. **验证了端到端分类流程**：最后，我通过 `test_end_to_end_classification.py` 脚本，完整地展示了从原始文本输入 -> 词元化 -> 标签生成 -> 模型前向传播 -> 分类损失计算的整个生命周期，确认了流程的正确性。

