# 因果语言模型数学概览

本文档旨在为读者提供 CausalQwen 模型核心数学思想的直观概览。我们的目标是解释"为什么"和"是什么"，而将更深层次的"如何推导"留给 `design-docs` 目录下的专业文档。

## 1. 核心动机：超越关联，拥抱因果

传统机器学习模型擅长学习**关联** ($P(y|x)$)，但难以回答**反事实**问题（"如果...会怎样?"）。为了真正实现因果推理，我们需要一个能够对个体的内在特性进行建模的框架。

本项目的理论基石 ([arXiv:2401.15911](https://arxiv.org/abs/2401.15911)) 从数学上证明，为了构建一个能够灵活表达反事实的因果模型，引入一个外生的**"个体选择变量" $U$** 是必要的。

> 深度解读请参见: [`design-docs/U_deep_dive.md`](design-docs/U_deep_dive.md)

## 2. $U$ 的双重角色：选择与表征

变量 $U$ 是理解本模型所有魔法的关键。它有两个核心身份：

1.  **个体选择变量 (Individual Selection Variable)**：一次具体的赋值 $U=u$ 代表着从所有可能的个体中"选中"了某一个特定个体 `u`。
2.  **个体因果表征 (Individual Causal Representation)**：被选中的向量 $u$ 本身，就包含了该个体所有内在的、驱动其行为的潜在属性。

**核心思想**：普适的因果律 ($Y=f(T;u)$) 应用于不同的个体 ($u$)，从而产生了不同的反事实结果 ($Y(t)$)。$U$ 是所有个体性差异的最终来源。

## 3. 推断-行动范式 (Abduction-Action Paradigm)

基于 $U$ 的概念，我们将决策过程分解为两个逻辑步骤：

#### 步骤 1: 推断 (Abduction) - "你是谁？"

我们无法直接观测到一个个体真实的 $u$。但我们可以根据其外在的**证据 $x$**，来推断他属于哪个**子群体 (Sub-population)**。

推断网络 (Abduction Network) 的任务正是如此：它接收证据 $x$，并输出一个后验概率分布 $P(U|x)$。这个分布就是对该子群体的数学画像。
\[
U|x \sim \text{Cauchy}(\text{loc}_U, \text{scale}_U)
\]
-   $\text{loc}_U$: 该子群体的"典型特征"或"平均画像"。
-   $\text{scale}_U$: 该子群体内部的"多样性"或我们认知的不确定性。

#### 步骤 2: 行动 (Action) - "你会做什么？"

一旦我们对个体所属的群体有了认知 ($P(U|x)$)，我们就可以预测该群体在不同干预下的反应。

行动网络 (Action Network) 基于推断出的分布参数 ($\text{loc}_U, \text{scale}_U$)，直接解析地计算出不同行动（分类或回归）的结果分布。

-   **分类决策分数**: $S_k|x \sim \text{Cauchy}(\dots)$
-   **回归值**: $Y|x \sim \text{Cauchy}(\dots)$

## 4. 数学引擎：柯西分布的威力

我们选择**柯西分布**来贯穿整个模型，核心优势在于其**线性稳定性**。这意味着柯西变量的线性组合仍然是柯西变量。

这一优美的数学特性，使得从 $U$ 的分布到 $S_k$ 和 $Y$ 的分布的整个前向传播过程，可以**完全在分布参数层面进行解析计算**，无需任何耗时的蒙特卡洛采样，保证了训练的高效性。

> 详细的数学推导请参见: [`design-docs/math/mathematical_foundations.md`](design-docs/math/mathematical_foundations.md)

## 5. 训练策略：门控损失函数

为了让模型能自主学习何时进行文本分类、何时进行数值回归，我们设计了**门控损失函数**。

其核心思想是，只有当模型自己预测当前应该输出数值 (`<NUM>` 词元) 时，我们才按比例地激活回归任务的损失。这通过将回归损失与 `<NUM>` 词元的预测概率相乘来实现。

\[
\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{classification}} + P(\text{<NUM>}) \cdot \mathcal{L}_{\text{regression}}
\]

这种机制使得模型在训练初期专注于更简单的分类任务，在对任务有一定理解后，才逐渐将注意力转移到更复杂的回归任务上，实现了"课程学习"的自动化。

