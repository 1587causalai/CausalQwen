# CausalQwen VS Qwen å¯¹æ¯”åˆ†æï¼šè®¾è®¡éªŒè¯ä¸å®ç°è§„èŒƒ

**æ—¥æœŸ:** 2025å¹´6æœˆ11æ—¥  
**ç›®çš„:** éªŒè¯ `scripts/compare_causal_vs_qwen.py` è„šæœ¬çš„è®¾è®¡è´¨é‡ä¸å®ç°è§„èŒƒ  
**èƒŒæ™¯:** åŸºäºç”¨æˆ·éœ€æ±‚åˆ›å»ºçš„çŸ¥è¯†ä¼ è¾“åˆå§‹åŒ–éªŒè¯å·¥å…·

---

## æ‘˜è¦

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æäº† `compare_causal_vs_qwen.py` è„šæœ¬çš„è®¾è®¡ç†å¿µã€æŠ€æœ¯å®ç°å’Œé¢„æœŸç»“æœï¼Œä¸ºç”¨æˆ·æä¾›éªŒè¯ä»£ç è´¨é‡çš„å®Œæ•´æ¡†æ¶ã€‚è¯¥è„šæœ¬çš„æ ¸å¿ƒä½¿å‘½æ˜¯**é‡åŒ–éªŒè¯ CausalQwen ä» Qwen çš„çŸ¥è¯†ä¼ è¾“æ•ˆæœ**ï¼Œç¡®ä¿æ¶æ„é‡æ„åœ¨ä¿æŒåŸæœ‰èƒ½åŠ›çš„åŒæ—¶æˆåŠŸæ‰©å±•äº†å› æœæ¨ç†åŠŸèƒ½ã€‚

**è®¾è®¡åŸåˆ™ç¡®è®¤:**
1. **å¯¹æ¯”ä¼˜å…ˆçº§æ­£ç¡®**: å‰å‘ä¼ æ’­ç»“æœ > æ¨¡å‹å‚æ•°ç»“æ„
2. **éªŒè¯ç»´åº¦å®Œå¤‡**: æ•°å€¼ä¸€è‡´æ€§ + æ¶æ„åˆ›æ–°æ€§ + åŠŸèƒ½æ‰©å±•æ€§
3. **åˆ†ææ·±åº¦é€‚å½“**: æ—¢æœ‰å®è§‚ç»Ÿè®¡ï¼Œåˆæœ‰å¾®è§‚ç»†èŠ‚

---

## 1. è„šæœ¬è®¾è®¡æ¶æ„åˆ†æ

### 1.1 æ ¸å¿ƒè®¾è®¡ç†å¿µéªŒè¯

**âœ… è®¾è®¡ç†å¿µæ­£ç¡®æ€§æ£€æŸ¥:**

è„šæœ¬çš„è®¾è®¡å®Œå…¨éµå¾ªäº†ç”¨æˆ·æå‡ºçš„å…³é”®éœ€æ±‚ï¼š

> è¦æ‰“å°æˆ‘ä»¬çš„æ¨¡å‹åˆå§‹åŒ–åçš„ç»“æœï¼Œé¦–å…ˆè¦æŠŠ Qwen æ¨¡å‹ä¸­ç›¸å…³çš„ç»“æœæ‰“å°å‡ºæ¥ï¼Œè¿™æ ·æ‰æ–¹ä¾¿å¯¹æ¯”éªŒè¯åˆå§‹åŒ–æ˜¯å¦ç¬¦åˆé¢„æœŸ

**å®ç°å¯¹ç…§:**
```python
# 1. ä¼˜å…ˆçº§æ’åºæ­£ç¡® âœ…
def main():
    # æ¨¡å‹æ¶æ„å¯¹æ¯” (æ¬¡è¦)
    analyze_model_architectures(causal_model, qwen_model)
    # æƒé‡ç»§æ‰¿åˆ†æ (æ¬¡è¦) 
    analyze_weight_inheritance(causal_model, qwen_model, tokenizer)
    # å‰å‘ä¼ æ’­å¯¹æ¯” (ä¸»è¦) - æ”¾åœ¨æœ€é‡è¦ä½ç½®
    causal_outputs, qwen_outputs = compare_forward_pass(...)
```

**éªŒè¯ç‚¹:** è„šæœ¬æ˜¯å¦å°†å‰å‘ä¼ æ’­å¯¹æ¯”ä½œä¸ºæ ¸å¿ƒåŠŸèƒ½ï¼Ÿ **âœ… é€šè¿‡**

### 1.2 åŠŸèƒ½æ¨¡å—åŒ–è®¾è®¡è¯„ä¼°

è„šæœ¬é‡‡ç”¨äº†æ¸…æ™°çš„æ¨¡å—åŒ–è®¾è®¡ï¼š

```mermaid
graph TD
    A[mainå‡½æ•°] --> B[æ¨¡å‹è®¾ç½®]
    A --> C[analyze_model_architectures]
    A --> D[analyze_weight_inheritance] 
    A --> E[compare_forward_pass]
    
    E --> F[ç‰¹å¾è¡¨å¾å¯¹æ¯”]
    E --> G[è¾“å‡ºæ¦‚ç‡å¯¹æ¯”]
    E --> H[ä½ç½®çº§åˆ«åˆ†æ]
    E --> I[å› æœè¡¨å¾åˆ†æ]
    
    style E fill:#e8f5e8,stroke:#4caf50
    style F fill:#e8f5e8,stroke:#4caf50
    style G fill:#e8f5e8,stroke:#4caf50
    style H fill:#e8f5e8,stroke:#4caf50
    style I fill:#e8f5e8,stroke:#4caf50
```

**éªŒè¯æ£€æŸ¥ç‚¹:**
- âœ… å‡½æ•°èŒè´£å•ä¸€ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- âœ… æ•°æ®æµæ¸…æ™°ï¼Œé¿å…å…¨å±€çŠ¶æ€æ±¡æŸ“
- âœ… é”™è¯¯å¤„ç†é€‚å½“ï¼Œè€ƒè™‘è¾¹ç•Œæƒ…å†µ

---

## 2. å‰å‘ä¼ æ’­å¯¹æ¯”çš„æŠ€æœ¯æ­£ç¡®æ€§

### 2.1 æ•°æ®æµä¸€è‡´æ€§éªŒè¯

**å…³é”®è®¾è®¡å†³ç­–:** ä½¿ç”¨ç›¸åŒçš„è¾“å…¥æ•°æ®ç¡®ä¿å¯¹æ¯”å…¬å¹³æ€§

```python
# æ­£ç¡®çš„æ•°æ®å‡†å¤‡ âœ…
texts = [
    "The item costs 99.99 dollars.",      # åŒ…å«æ•°å€¼
    "From a batch of 100 items, 5 were defective.",  # å¤šä¸ªæ•°å€¼
    "A simple text without numbers."      # æ— æ•°å€¼åŸºå‡†
]

# ä½¿ç”¨CausalQwençš„åˆ†è¯å™¨ - è¿™æ˜¯æ­£ç¡®çš„é€‰æ‹© âœ…
inputs = tokenizer.batch_encode_plus(texts, padding=True, truncation=True, return_tensors='pt')
```

**è®¾è®¡åˆç†æ€§åˆ†æ:**
- **âœ… æµ‹è¯•æ ·æœ¬å¤šæ ·æ€§**: åŒ…å«æ•°å€¼ã€å¤šæ•°å€¼ã€æ— æ•°å€¼ä¸‰ç§æƒ…å†µ
- **âœ… åˆ†è¯å™¨ä¸€è‡´æ€§**: ä½¿ç”¨ `QwenTokenizerWrapper` ç¡®ä¿ `<NUM>` token å¤„ç†æ­£ç¡®
- **âœ… è¾“å…¥æ ¼å¼å…¼å®¹**: `CausalQwen` ä½¿ç”¨å®Œæ•´è¾“å…¥ï¼Œ`Qwen` ä½¿ç”¨å­é›†

### 2.2 ç‰¹å¾è¡¨å¾å¯¹æ¯”çš„æ•°å­¦ä¸¥æ ¼æ€§

**æ ¸å¿ƒéªŒè¯é€»è¾‘:**
- **âœ… æ¯”è¾ƒå¯¹è±¡æ­£ç¡®**: éƒ½æ˜¯æœ€åä¸€å±‚çš„éšè—çŠ¶æ€
- **âœ… é¢„æœŸç»“æœæ˜ç¡®**: åº”è¯¥å®Œå…¨ä¸€è‡´ï¼Œå› ä¸ºä½¿ç”¨ç›¸åŒçš„ Qwen backbone

**ç†è®ºä¾æ®:** æ ¹æ® `design-docs/core-design.md`ï¼Œ`QwenFeatureNetwork` ç›´æ¥ä½¿ç”¨ Qwen æ¨¡å‹ï¼Œå› æ­¤ç‰¹å¾åº”è¯¥identicalã€‚

### 2.3 æ¦‚ç‡åˆ†å¸ƒå¯¹æ¯”çš„ç»Ÿè®¡å­¦æ„ä¹‰

**å®ç°ç­–ç•¥:**
```python
# ä½¿ç”¨ scores è€Œä¸æ˜¯æ¦‚ç‡åˆ†å¸ƒå¯¹æ¯”ï¼Œ è¿™æ‰æ˜¯çŸ¥è¯†ä¼ è¾“çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚
CausalQwen_Scores = ....
Qwen_Scores = ...
print_tensor_comparison(CausalQwen_Scores, Qwen_Scores, ...)
```

**ç»Ÿè®¡å­¦è¯„ä¼°:**
- **âœ… å½’ä¸€åŒ–æ­£ç¡®**: åˆå§‹åŒ–ä»¥åï¼Œä½¿ç”¨ `softmax` ç¡®ä¿æ¦‚ç‡åˆ†å¸ƒçš„ç›¸ä¼¼åº¦å¾ˆå¤§ï¼ˆCausalQwen æ¯” Qwen å¤šä¸€ä¸ª <NUM> è¯æ±‡ï¼‰


å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š
**Qwen çš„æ¦‚ç‡è®¡ç®— (æ ‡å‡† Softmax):**
$$P_{\text{Qwen}}(k|x) = \frac{\exp(S_k^{\text{Qwen}})}{\sum_{j=1}^{K} \exp(S_j^{\text{Qwen}})}$$

**CausalQwen çš„æ¦‚ç‡è®¡ç®— (Cauchy OvR):**
$$P_{\text{CausalQwen}}(k|x) = P(S_k > \text{threshold}) = \frac{1}{2} + \frac{1}{\pi} \arctan\left(\frac{\text{loc}_k - \text{threshold}}{\text{scale}_k}\right)$$

**å…³é”®å·®å¼‚åˆ†æ:**
1. **Qwen**: åŸºäºç›¸å¯¹æ¯”è¾ƒçš„ softmax å½’ä¸€åŒ–ï¼Œæ‰€æœ‰æ¦‚ç‡å’Œä¸º1
2. **CausalQwen**: åŸºäºç»å¯¹é˜ˆå€¼çš„ç‹¬ç«‹äºŒåˆ†ç±»ï¼Œæ¯ä¸ª token æ¦‚ç‡ç‹¬ç«‹è®¡ç®—

**éªŒè¯ç­–ç•¥ä¿®æ­£:** åº”è¯¥é‡ç‚¹æ¯”è¾ƒ `cls_loc` å‚æ•°æœ¬èº«ï¼Œè€Œä¸æ˜¯è½¬æ¢åçš„æ¦‚ç‡åˆ†å¸ƒï¼Œå› ä¸ºæ¦‚ç‡è®¡ç®—æœºåˆ¶å®Œå…¨ä¸åŒã€‚

**æ•°å­¦éªŒè¯é‡ç‚¹:** éªŒè¯åœ¨ç›¸åŒç‰¹å¾è¾“å…¥ä¸‹ï¼Œ`cls_loc` å‚æ•°æ˜¯å¦æ¥è¿‘ Qwen çš„ logitsï¼Œ

---

## 3. æƒé‡ç»§æ‰¿åˆ†æçš„è®¾è®¡æ·±åº¦

### 3.1 å…³é”®æƒé‡æ˜ å°„çš„æ­£ç¡®æ€§

**æ ¸å¿ƒæ˜ å°„å…³ç³»:**
```python
# ActionNetworkåˆ†ç±»å¤´ â†â†’ Qwen lm_head
causal_cls_weight = causal_model.action_network.classification_head.causal_linear.weight.data
qwen_lm_weight = qwen_model.lm_head.weight.data
```

**æ˜ å°„æ­£ç¡®æ€§éªŒè¯:**
- **âœ… æƒé‡ç»´åº¦å¯¹åº”**: éƒ½æ˜¯ `[vocab_size, hidden_size]`
- **âœ… åŠŸèƒ½è¯­ä¹‰ä¸€è‡´**: éƒ½è´Ÿè´£ä»éšè—çŠ¶æ€åˆ°è¯æ±‡è¡¨çš„æ˜ å°„
- **âœ… é¢„æœŸç»§æ‰¿å…³ç³»**: `causal_cls_weight` åº”è¯¥ä» `qwen_lm_weight` åˆå§‹åŒ–

**ğŸ“Š è¯„è®ºå›åº” - è¯æ±‡è¡¨æ‰©å±•çš„æ•°å­¦åˆ†æ:**

**è¯æ±‡è¡¨ç»´åº¦å·®å¼‚:**
- **Qwen**: $W_{\text{Qwen}} \in \mathbb{R}^{K \times H}$ (K = 151665)
- **CausalQwen**: $W_{\text{CausalQwen}} \in \mathbb{R}^{(K+1) \times H}$ (K+1 = 151666, æ–°å¢ `<NUM>` token)

**çŸ¥è¯†ä¼ è¾“çš„æ•°å­¦è¿‡ç¨‹:**
$$W_{\text{CausalQwen}}[:-1, :] = W_{\text{Qwen}}, b_{\text{CausalQwen}}[:-1] = b_{\text{Qwen}} \quad \text{(å‰Kè¡Œå®Œå…¨ç»§æ‰¿)}$$
$$W_{\text{CausalQwen}}[-1, :] = \text{special\_init}(<\text{NUM}>)\quad \text{(æœ€åä¸€è¡Œç‰¹æ®Šåˆå§‹åŒ–)}$$

**ä¿®æ­£åçš„å®Œæ•´çŸ¥è¯†ä¼ è¾“ç­–ç•¥:**


ç»™å®šç‰¹å¾ $z_i \in \mathbb{R}^H$ï¼Œä¸¤ä¸ªæ¨¡å‹çš„è¾“å‡ºå¾—åˆ†å¯¹æ¯”ï¼š

**Qwençš„è¾“å‡ºå¾—åˆ†:**
$$S_k^{\text{Qwen}} = W_{\text{Qwen}}[k, :] \cdot z_i + b_{\text{Qwen}}[k]$$

**CausalQwençš„è¾“å‡ºå¾—åˆ† (ä¿®æ­£åçš„å®Œæ•´ç»§æ‰¿):**
- **AbductionNetworkæ’ç­‰æ˜ å°„**: $\text{causal\_loc}_i = I \cdot z_i + 0 = z_i$ (ç²¾ç¡®ç­‰äº)
- **å®Œæ•´çŸ¥è¯†ä¼ è¾“**: $W_{\text{CausalQwen}}[k, :] = W_{\text{Qwen}}[k, :]$ ä¸” $b_{\text{CausalQwen}}[k] = b_{\text{Qwen}}[k]$

å› æ­¤ï¼š
$$S_k^{\text{CausalQwen}} = W_{\text{CausalQwen}}[k, :] \cdot \text{causal\_loc}_i + b_{\text{CausalQwen}}[k]$$
$$= W_{\text{Qwen}}[k, :] \cdot z_i + b_{\text{Qwen}}[k] = S_k^{\text{Qwen}}$$

**å…³é”®æ•°å­¦ç»“è®º:**
å¯¹äºå‰Kä¸ªtoken ($k < K$)ï¼š
$$S_k^{\text{CausalQwen}} = S_k^{\text{Qwen}} \quad \text{(å®Œå…¨ä¸€è‡´)}$$

**éªŒè¯é‡ç‚¹:** æ£€æŸ¥æ˜¯å¦ $S_k^{\text{CausalQwen}} = S_k^{\text{Qwen}}$ï¼Œå³**å®Œå…¨æ•°å€¼ä¸€è‡´**ï¼Œè€Œä¸ä»…ä»…æ˜¯ç›¸å…³æ€§ã€‚

### 3.2 ç‰¹æ®ŠTokenå¤„ç†çš„éªŒè¯æ·±åº¦

**`<NUM>` Tokenä¸“é—¨åˆ†æ:**
```python
num_token_id = tokenizer.num_token_id
num_bias_causal = causal_cls_bias[num_token_id].item()
other_bias_mean = causal_cls_bias[causal_cls_bias != causal_cls_bias[num_token_id]].mean().item()
```

**è®¾è®¡åˆç†æ€§:**
- **âœ… ç‰¹æ®Šæ€§æ£€æµ‹**: éªŒè¯ `<NUM>` token æ˜¯å¦æœ‰ç‰¹æ®Šåˆå§‹åŒ–
- **âœ… å¯¹æ¯”åŸºå‡†**: ä½¿ç”¨å…¶ä»– token çš„å¹³å‡å€¼ä½œä¸ºå¯¹ç…§
- **â“ é˜ˆå€¼è®¾å®š**: `abs(num_bias_causal - other_bias_mean) > 0.1` æ˜¯å¦åˆé€‚ï¼Ÿ

**ä¿®æ­£åçš„ç†è®ºæœŸæœ›:** æ ¹æ®å®Œæ•´çŸ¥è¯†ä¼ è¾“è®¾è®¡ï¼š

1. **ç»§æ‰¿token**: æƒé‡+åç½®å®Œå…¨ç»§æ‰¿ï¼Œä¿æŒä¸Qwenä¸€è‡´çš„è¡Œä¸º
2. **<NUM> token**: ç‰¹æ®Šåˆå§‹åŒ–ï¼Œåç½®ä¹Ÿéœ€è¦åˆç†è®¾ç½®

**ğŸ”¢ ä¿®æ­£åçš„ <NUM> Tokenæ¦‚ç‡åˆ†æ:**

**è®¾è®¡åŸç†:** `<NUM>` tokenåœ¨ä¼ ç»Ÿsoftmaxä¸‹åº”è¯¥æ¦‚ç‡å¾ˆä½ï¼Œä½†ç°åœ¨éœ€è¦è€ƒè™‘å®Œæ•´çš„æƒé‡+åç½®ä½“ç³»ã€‚

**æ•°å­¦åˆ†æ (ä¿®æ­£ç‰ˆ):**

è€ƒè™‘å®Œæ•´çš„åˆ†ç±»å¾—åˆ†è®¡ç®—ï¼š
$$S_k = W_k \cdot z_i + b_k$$

å¯¹äºsoftmaxæ¦‚ç‡ï¼š
$$P_{\text{softmax}}(\text{<NUM>}) = \frac{\exp(S_{\text{<NUM>}})}{\sum_{k=1}^{K+1} \exp(S_k)}$$

**ä¸ºä»€ä¹ˆ `<NUM>` æ¦‚ç‡åº”è¯¥å¾ˆä½ (ä¿®æ­£åˆ†æ):**

1. **å®Œæ•´çŸ¥è¯†ä¼ è¾“ç­–ç•¥:**
   - ç»§æ‰¿çš„token: $W_k = W_{\text{Qwen}}[k, :]$, $b_k = b_{\text{Qwen}}[k]$ (å®Œæ•´ç»§æ‰¿)
   - `<NUM>` token: $(W_{\text{<NUM>}}, b_{\text{<NUM>}})$ éœ€è¦ç‰¹æ®Šåˆå§‹åŒ–

2. **å¾—åˆ†å·®å¼‚çš„æ•°å­¦æœŸæœ›:**
   å¯¹äºè¯­è¨€ä¸Šä¸‹æ–‡ $z_i$ï¼š
   $$S_{\text{language}} = W_{\text{language}} \cdot z_i + b_{\text{language}} \quad \text{(å·²ä¼˜åŒ–)}$$
   $$S_{\text{<NUM>}} = W_{\text{<NUM>}} \cdot z_i + b_{\text{<NUM>}} \quad \text{(éšæœºåˆå§‹åŒ–)}$$

3. **Softmaxç«äº‰æœºåˆ¶:**
   ç”±äºè¯­è¨€tokençš„å‚æ•°å·²ç»è¿‡ä¼˜åŒ–ï¼š
   $$S_{\text{language}} >> S_{\text{<NUM>}} \quad \text{(åœ¨è¯­è¨€ä¸Šä¸‹æ–‡ä¸­)}$$

**æ•°å­¦éªŒè¯å…¬å¼ (ä¿®æ­£ç‰ˆ):**
$$\frac{P_{\text{softmax}}(\text{<NUM>})}{P_{\text{softmax}}(\text{language\_token})} = \exp(S_{\text{<NUM>}} - S_{\text{language}}) << 1$$

**éªŒè¯æ ‡å‡†:** åœ¨çº¯è¯­è¨€ä¸Šä¸‹æ–‡ä¸­ï¼Œ$P_{\text{softmax}}(\text{<NUM>}) < 0.01$ è¡¨æ˜ç‰¹æ®Štokenä¸ä¼šå¹²æ‰°æ­£å¸¸è¯­è¨€å»ºæ¨¡ã€‚

---

## 4. æ¨¡å‹æ¶æ„å¯¹æ¯”çš„å…¨é¢æ€§

### 4.1 å‚æ•°ç»Ÿè®¡çš„å‡†ç¡®æ€§

**ç»Ÿè®¡ç»´åº¦:**
```python
causal_total_params = sum(p.numel() for p in causal_model.parameters())
causal_trainable_params = sum(p.numel() for p in causal_model.parameters() if p.requires_grad)
```

**ç»Ÿè®¡æ­£ç¡®æ€§:**
- **âœ… æ€»å‚æ•°ç»Ÿè®¡**: åŒ…å«æ‰€æœ‰æ¨¡å‹å‚æ•°
- **âœ… å¯è®­ç»ƒå‚æ•°åŒºåˆ†**: è€ƒè™‘äº† `requires_grad` çŠ¶æ€
- **âœ… å·®å¼‚é‡åŒ–**: è®¡ç®—å‚æ•°å¢é‡ï¼Œæœ‰åŠ©äºç†è§£æ¶æ„æ‰©å±•æˆæœ¬

### 4.2 æƒé‡å…±äº«éªŒè¯çš„æŠ€æœ¯æ·±åº¦

**å…±äº«æƒé‡æ£€æŸ¥:**
```python
shared_keys = set(causal_qwen_weights.keys()) & set(qwen_weights.keys())
weight_identical = torch.equal(causal_qwen_weights[key], qwen_weights[key])
```

**æŠ€æœ¯è¯„ä¼°:**
- **âœ… é”®é›†åˆæ¯”è¾ƒ**: æ­£ç¡®è¯†åˆ«å…±äº«æƒé‡
- **âœ… ç²¾ç¡®æ¯”è¾ƒ**: ä½¿ç”¨ `torch.equal` ç¡®ä¿ä¸¥æ ¼ä¸€è‡´æ€§
- **âœ… å…³é”®æƒé‡èšç„¦**: é€‰æ‹©ä»£è¡¨æ€§çš„æƒé‡è¿›è¡ŒéªŒè¯

**éªŒè¯å……åˆ†æ€§:** é€‰æ‹©çš„æƒé‡ (`embed_tokens`, `self_attn.q_proj`, `mlp.gate_proj`) æ¶µç›–äº†åµŒå…¥ã€æ³¨æ„åŠ›ã€å‰é¦ˆç½‘ç»œçš„ä»£è¡¨æ€§ç»„ä»¶ã€‚

---

## 5. è¾“å‡ºä¿¡æ¯çš„å¯ç†è§£æ€§ä¸å¯æ“ä½œæ€§

### 5.1 æ‰“å°æ ¼å¼çš„ç”¨æˆ·å‹å¥½æ€§

**æ ¼å¼è®¾è®¡è¯„ä¼°:**
```python
def print_section(title, level=1):
    symbols = ['=', '-', '~', '.']
    symbol = symbols[min(level-1, len(symbols)-1)]
    # ... å±‚æ¬¡åŒ–æ ‡é¢˜æ ¼å¼
```

**ç”¨æˆ·ä½“éªŒ:**
- **âœ… å±‚æ¬¡æ¸…æ™°**: ä½¿ç”¨ä¸åŒç¬¦å·åŒºåˆ†ç« èŠ‚å±‚çº§
- **âœ… è§†è§‰ç»Ÿä¸€**: ä¿æŒä¸€è‡´çš„æ ¼å¼åŒ–é£æ ¼
- **âœ… ä¿¡æ¯å¯†åº¦é€‚ä¸­**: é¿å…ä¿¡æ¯è¿‡è½½

### 5.2 å¯¹æ¯”è¡¨æ ¼çš„ä¿¡æ¯å®Œæ•´æ€§

**å¼ é‡å¯¹æ¯”æ ¼å¼:**
```python
print(f"{'æŒ‡æ ‡':<20} {name1:<20} {name2:<20} {'å·®å¼‚':<15}")
print(f"{'ä½™å¼¦ç›¸ä¼¼åº¦':<20} {cosine_sim:<20.6f} {'N/A':<20} {'N/A':<15}")
```

**ä¿¡æ¯å®Œæ•´æ€§è¯„ä¼°:**
- **âœ… åŸºç¡€ç»Ÿè®¡**: å‡å€¼ã€æ ‡å‡†å·®ã€æœ€å€¼
- **âœ… ç›¸ä¼¼æ€§åº¦é‡**: ä½™å¼¦ç›¸ä¼¼åº¦ã€å‡æ–¹è¯¯å·®
- **âœ… å·®å¼‚é‡åŒ–**: ç»å¯¹å·®å¼‚è®¡ç®—

**æ½œåœ¨æ”¹è¿›:** å¯è€ƒè™‘æ·»åŠ ç›¸å¯¹å·®å¼‚ç™¾åˆ†æ¯”å’Œç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒã€‚

---

## 6. é¢„æœŸç»“æœä¸éªŒè¯æ ‡å‡†

### 6.1 æˆåŠŸéªŒè¯çš„é¢„æœŸæ¨¡å¼

**ä¿®æ­£åçš„éªŒè¯æˆåŠŸæ¨¡å¼:**

```
ç‰¹å¾æ˜¯å¦å®Œå…¨ä¸€è‡´: âœ… (åº”è¯¥å®Œå…¨ä¸€è‡´ï¼Œå› ä¸ºä½¿ç”¨ç›¸åŒbackbone)
å…³é”®æƒé‡å®Œå…¨å…±äº«: âœ… (3/3æ£€æŸ¥é€šè¿‡)
æƒé‡+åç½®å®Œæ•´ç»§æ‰¿: âœ… (å‰Kä¸ªtokençš„å®Œæ•´å‚æ•°ç»§æ‰¿)
åˆ†ç±»å¾—åˆ†å®Œå…¨ä¸€è‡´: âœ… (å¯¹ç»§æ‰¿token: S_CausalQwen = S_Qwen)
<NUM>tokenç‰¹æ®Šåˆå§‹åŒ–: âœ… (æƒé‡å’Œåç½®çš„ç‰¹æ®Šè®¾ç½®)
å› æœè¡¨å¾åˆå§‹åŒ–: causal_scale â‰ˆ 10.0 âœ…
```

**ä¿®æ­£åçš„åˆ¤æ–­æ ‡å‡†:**
- **ç‰¹å¾å®Œå…¨ä¸€è‡´**: åº”è¯¥å®Œå…¨ç›¸åŒï¼Œè¯æ˜ `QwenFeatureNetwork` æ­£ç¡®ä½¿ç”¨ Qwen backbone
- **å®Œæ•´çŸ¥è¯†ä¼ è¾“**: æƒé‡+åç½®éƒ½æˆåŠŸç»§æ‰¿ï¼Œä¿æŒQwençš„å®Œæ•´è¡Œä¸º
- **æ•°å­¦ä¸€è‡´æ€§**: ç»§æ‰¿tokençš„åˆ†ç±»å¾—åˆ†åº”è¯¥ $S_k^{\text{CausalQwen}} = S_k^{\text{Qwen}}$
- **<NUM>tokenç‹¬ç‰¹æ€§**: ä»…æ–°å¢tokenæœ‰ç‰¹æ®Šåˆå§‹åŒ–ï¼Œä¸å½±å“ç»§æ‰¿è¡Œä¸º

### 6.2 å¼‚å¸¸æƒ…å†µçš„è¯Šæ–­èƒ½åŠ›

**è„šæœ¬åº”è¯¥èƒ½è¯†åˆ«çš„é—®é¢˜:**

1. **ç‰¹å¾ä¸ä¸€è‡´** (`features_identical = False`):
   - **å¯èƒ½åŸå› **: `QwenFeatureNetwork` å®ç°é”™è¯¯
   - **è¯Šæ–­ä¿¡æ¯**: æœ€å¤§å·®å¼‚å€¼ï¼Œå¸®åŠ©å®šä½é—®é¢˜

2. **æƒé‡ç»§æ‰¿å¤±è´¥** (ä½™å¼¦ç›¸ä¼¼åº¦ < 0.8):
   - **å¯èƒ½åŸå› **: `init_weights` æ–¹æ³•æœ‰ bug
   - **è¯Šæ–­ä¿¡æ¯**: æƒé‡ç»Ÿè®¡å¯¹æ¯”ï¼Œè¯†åˆ«åˆ†å¸ƒå·®å¼‚

3. **æ¦‚ç‡åˆ†å¸ƒåå·®è¿‡å¤§** (ä½™å¼¦ç›¸ä¼¼åº¦ < 0.7):
   - **å¯èƒ½åŸå› **: `ActionNetwork` å®ç°é—®é¢˜
   - **è¯Šæ–­ä¿¡æ¯**: ä½ç½®çº§åˆ«çš„è¯¦ç»†åˆ†æ

---

## 7. ä»£ç è´¨é‡è¯„ä¼°æ ‡å‡†

### 7.1 ä»£ç å¯è¯»æ€§è¯„åˆ†

**âœ… ä¼˜ç§€æ–¹é¢:**
- å‡½æ•°å‘½åè¯­ä¹‰æ˜ç¡® (`analyze_weight_inheritance`, `compare_forward_pass`)
- æ³¨é‡Šå……åˆ†ï¼Œè¯´æ˜è®¾è®¡æ„å›¾
- å˜é‡å‘½åå…·æœ‰æè¿°æ€§ (`causal_cls_weight`, `qwen_lm_weight`)

**â“ å¯æ”¹è¿›æ–¹é¢:**
- éƒ¨åˆ†é­”æ³•æ•°å­—å¯ä»¥æå–ä¸ºå¸¸é‡ (å¦‚ `atol=1e-6`, `> 0.1`)
- æŸäº›å¤æ‚é€»è¾‘å¯ä»¥æå–ä¸ºç‹¬ç«‹å‡½æ•°

### 7.2 é”™è¯¯å¤„ç†èƒ½åŠ›è¯„ä¼°

**ç°æœ‰é”™è¯¯å¤„ç†:**
```python
if hasattr(qwen_model.lm_head, 'bias') and qwen_model.lm_head.bias is not None:
    qwen_lm_bias = qwen_model.lm_head.bias.data
else:
    qwen_lm_bias = None
```

**é”™è¯¯å¤„ç†è¯„ä¼°:**
- **âœ… è¾¹ç•Œæƒ…å†µè€ƒè™‘**: å¤„ç†äº† Qwen å¯èƒ½æ²¡æœ‰åç½®çš„æƒ…å†µ
- **â“ å¯æ‰©å±•æ€§**: å¯è€ƒè™‘æ·»åŠ æ›´å¤šçš„å¼‚å¸¸æ•è·å’Œå‹å¥½é”™è¯¯ä¿¡æ¯

### 7.3 æ€§èƒ½è€ƒè™‘

**å†…å­˜ä½¿ç”¨:**
- **âœ… åˆç†**: ä½¿ç”¨ `torch.no_grad()` é¿å…æ¢¯åº¦è®¡ç®—
- **âœ… é€‚ä¸­**: åœ¨ CPU ä¸Šè¿è¡Œï¼Œé¿å… GPU å†…å­˜é—®é¢˜

**è®¡ç®—æ•ˆç‡:**
- **âœ… é«˜æ•ˆ**: å¼ é‡æ“ä½œçŸ¢é‡åŒ–ï¼Œé¿å…å¾ªç¯
- **â“ ä¼˜åŒ–ç©ºé—´**: æŸäº›ç»Ÿè®¡è®¡ç®—å¯ä»¥æ‰¹é‡åŒ–

---

## 8. ä¸è®¾è®¡æ–‡æ¡£çš„ä¸€è‡´æ€§éªŒè¯

### 8.1 ä¸ `mathematical_foundations.md` çš„å¯¹åº”å…³ç³»

**æ•°å­¦æ¦‚å¿µæ˜ å°„:**
- **ä¸ªä½“å› æœè¡¨å¾ $U_i$** â†” `causal_outputs['causal_loc/scale']`
- **æ¨æ–­-è¡ŒåŠ¨èŒƒå¼** â†” `AbductionNetwork` â†’ `ActionNetwork`
- **æŸ¯è¥¿åˆ†å¸ƒçº¿æ€§å˜æ¢** â†” `CauchyLinear` çš„æƒé‡å…±äº«éªŒè¯

**éªŒè¯è¦†ç›–åº¦:**
- **âœ… è¦†ç›–**: å› æœè¡¨å¾çš„ç»Ÿè®¡ç‰¹æ€§åˆ†æ
- **â“ å¯æ‰©å±•**: å¯æ·»åŠ æ›´å¤šçš„æ•°å­¦æ€§è´¨éªŒè¯ï¼ˆå¦‚çº¿æ€§å˜æ¢å°é—­æ€§ï¼‰

### 8.2 ä¸ `core-design.md` çš„æ¶æ„å¯¹åº”

**æ¶æ„ç»„ä»¶æ˜ å°„:**
- **ç‰¹å¾ç½‘ç»œ** â†” `QwenFeatureNetwork` æƒé‡å…±äº«éªŒè¯
- **æ¨æ–­ç½‘ç»œ** â†” `AbductionNetwork` è¾“å‡ºå½¢çŠ¶éªŒè¯
- **è¡ŒåŠ¨ç½‘ç»œ** â†” `ActionNetwork` åŒå¤´è¾“å‡ºéªŒè¯

**è®¾è®¡åŸåˆ™éµå¾ª:**
- **âœ… C=H çº¦æŸ**: éšå«åœ¨é…ç½®éªŒè¯ä¸­
- **âœ… åºåˆ—åˆ°åºåˆ—**: é€šè¿‡è¾“å‡ºå½¢çŠ¶éªŒè¯
- **âœ… çŸ¥è¯†ä¼ è¾“**: é€šè¿‡æƒé‡ç»§æ‰¿éªŒè¯

---

## 9. ä½¿ç”¨æŒ‡å—ä¸æœ€ä½³å®è·µ

### 9.1 è„šæœ¬æ‰§è¡Œçš„æœ€ä½³å®è·µ

**æ¨èæ‰§è¡Œç¯å¢ƒ:**
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd /path/to/CausalQwen2
python scripts/compare_causal_vs_qwen.py > comparison_results.txt 2>&1
```

**ç»“æœè§£è¯»æŒ‡å—:**
1. **å…ˆçœ‹ç‰¹å¾ä¸€è‡´æ€§**: è¿™æ˜¯æœ€åŸºç¡€çš„éªŒè¯
2. **å†çœ‹æƒé‡ç»§æ‰¿**: éªŒè¯çŸ¥è¯†ä¼ è¾“æ•ˆæœ
3. **æœ€åçœ‹æ¦‚ç‡åˆ†å¸ƒ**: è¯„ä¼°æ•´ä½“æ€§èƒ½ä¿æŒ

### 9.2 å¼‚å¸¸ç»“æœçš„å¤„ç†æµç¨‹

**è¯Šæ–­å†³ç­–æ ‘:**
```mermaid
graph TD
    A[è¿è¡Œè„šæœ¬] --> B{ç‰¹å¾ä¸€è‡´?}
    B -->|å¦| C[æ£€æŸ¥QwenFeatureNetworkå®ç°]
    B -->|æ˜¯| D{æƒé‡ç»§æ‰¿æ­£å¸¸?}
    D -->|å¦| E[æ£€æŸ¥init_weightsæ–¹æ³•]
    D -->|æ˜¯| F{æ¦‚ç‡åˆ†å¸ƒç›¸ä¼¼?}
    F -->|å¦| G[æ£€æŸ¥ActionNetworkå®ç°]
    F -->|æ˜¯| H[éªŒè¯é€šè¿‡ âœ…]
```
